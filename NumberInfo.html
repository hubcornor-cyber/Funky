<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Number Info Lookup</title>
  <style>
    body {
      background-color: #0ccca0;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }

    input, button, textarea {
      background-color: black;
      color: white;
      padding: 15px;
      border-radius: 25px;
      border: 1px solid #444;
      margin: 10px 0;
    }

    input {
      width: 75vh;
    }

    textarea {
      width: 90%;
      height: 300px;
      margin-top: 20px;
      resize: vertical;
      font-family: monospace;
      white-space: pre;
    }

    iframe {
      display: none;
    }

    .loading {
      margin-top: 10px;
      font-size: 18px;
      color: #ccc;
    }
  </style>
</head>
<body>

  <h2>Check SIM Details</h2>

  <form id="lookupForm">
    <input type="text" id="phoneNumber" placeholder="Enter Number e.g. 3001122333" required />
    <br />
    <button type="submit">Search</button>
  </form>

  <div class="loading" id="loadingText">Waiting for input...</div>

  <textarea id="responseBox" placeholder="Response will appear here..." readonly></textarea>

  <iframe id="scrapeFrame"></iframe>

  <script>
    const form = document.getElementById('lookupForm');
    const responseBox = document.getElementById('responseBox');
    const iframe = document.getElementById('scrapeFrame');
    const loadingText = document.getElementById('loadingText');

    const corsProxy = 'https://corsproxy.io/?';

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const number = document.getElementById("phoneNumber").value.trim();
      if (!number) {
        responseBox.value = "❌ Please enter a number.";
        return;
      }

      const targetUrl = `https://cnic.pk/track?user_input=${encodeURIComponent(number)}`;
      loadingText.textContent = "⏳ Trying iframe scrape...";
      responseBox.value = "⏳ Loading from iframe...";
      iframe.src = targetUrl;

      // Try reading from iframe after a short delay
      setTimeout(() => {
        try {
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          const bodyText = doc.body.innerText || "No text found in iframe body.";
          responseBox.value = bodyText;
          loadingText.textContent = "✅ Loaded from iframe.";
        } catch (error) {
          console.warn("Iframe access blocked. Using fallback fetch.");
          loadingText.textContent = "⚠️ Iframe blocked. Trying fallback fetch...";
          fetchFallback(targetUrl);
        }
      }, 2000); // Wait 2 seconds for iframe to load
    });

    async function fetchFallback(url) {
      try {
        responseBox.value = "⏳ Fetching via proxy...";
        const response = await fetch(corsProxy + encodeURIComponent(url));
        const text = await response.text();

        try {
          const json = JSON.parse(text);

          if (json.records && Array.isArray(json.records.Rows)) {
            const rows = json.records.Rows;
            const headers = json.records.Columns;

            // Build header line
            const headerLine = headers.map(h => h.padEnd(18)).join('|');
            const separator = '-'.repeat(headerLine.length);

            const dataLines = rows.map(row => {
              return [
                (row.Number || '').padEnd(18),
                (row.Name || '').padEnd(18),
                (row.CNIC || '').padEnd(18),
                (row.Address || '').padEnd(18)
              ].join('|');
            });

            const formatted = [headerLine, separator, ...dataLines].join('\n');
            responseBox.value = formatted;
            loadingText.textContent = `✅ Found ${rows.length} record(s).`;
          } else {
            responseBox.value = "⚠️ JSON received but format is unexpected.";
            loadingText.textContent = "⚠️ Unexpected format.";
          }
        } catch (e) {
          console.error("JSON parse error:", e);
          responseBox.value = "⚠️ Response is not valid JSON:\n\n" + text;
          loadingText.textContent = "⚠️ Raw response shown.";
        }

      } catch (err) {
        console.error("Fetch failed:", err);
        responseBox.value = "❌ Error fetching data: " + err.message;
        loadingText.textContent = "❌ Failed to fetch data.";
      }
    }
  </script>

</body>
</html>
