<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>🎬 Video Story Studio - Professional Text Overlays</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;600;700&family=Poppins:wght@300;400;600;700&family=Lora:wght@400;500;600&family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Bebas+Neue&family=Rajdhani:wght@300;400;600;700&family=Oswald:wght@300;400;700&family=Inter:wght@300;400;500;600;700&family=Roboto+Slab:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: linear-gradient(135deg, #3b82f6, #1d4ed8);
            --success: linear-gradient(135deg, #10b981, #059669);
            --warning: linear-gradient(135deg, #f59e0b, #d97706);
            --danger: linear-gradient(135deg, #ef4444, #dc2626);
            --secondary: linear-gradient(135deg, #6b7280, #4b5563);
            --dark-bg: #1e293b;
            --light-bg: #f8fafc;
            --border-dark: #475569;
            --border-light: #d1d5db;
            --text-primary-dark: #f1f5f9;
            --text-primary-light: #1e293b;
            --text-secondary-dark: #94a3b8;
            --text-secondary-light: #6b7280;
            --panel-bg-dark: rgba(30, 41, 59, 0.9);
            --panel-bg-light: rgba(255, 255, 255, 0.95);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            margin: 0;
            color: var(--text-primary-dark);
            background: linear-gradient(135deg, #0f172a, #1e293b);
            transition: all 0.3s ease;
            line-height: 1.6;
        }
        body.light {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: var(--text-primary-light);
        }
       
        .container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .top-row { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            width: 100%; 
            gap: 24px; 
        }
        .panel { 
            background: var(--panel-bg-dark); 
            backdrop-filter: blur(16px); 
            border-radius: 20px; 
            padding: 24px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, .3); 
            flex: 1; 
            min-width: 320px; 
            max-width: 600px; 
            border: 1px solid rgba(59, 130, 246, 0.2); 
        }
        body.light .panel { 
            background: var(--panel-bg-light); 
            border: 1px solid rgba(59, 130, 246, 0.1); 
        }
       
        h1 { 
            font-size: 32px; 
            margin: 0 0 10px; 
            background: var(--primary); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text; 
            font-weight: 700;
        }
        .subtitle {
            color: var(--text-secondary-dark);
            font-size: 16px;
            margin: 0;
        }
        body.light .subtitle { color: var(--text-secondary-light); }
        
        h2 { 
            margin: 0 0 16px; 
            font-size: 20px; 
            color: #93c5fd; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        body.light h2 { color: #1d4ed8; }
        h3 { 
            margin: 20px 0 12px; 
            font-size: 16px; 
            color: var(--text-primary-dark); 
            border-left: 4px solid #3b82f6; 
            padding-left: 16px; 
            font-weight: 600; 
        }
        body.light h3 { color: var(--text-primary-light); }
       
        label { 
            display: block; 
            margin: 12px 0 6px; 
            font-weight: 600; 
            font-size: 13px; 
            color: var(--text-primary-dark); 
        }
        body.light label { color: var(--text-primary-light); }
        input, textarea, select {
            width: 100%; 
            padding: 12px; 
            margin: 4px 0; 
            border: 2px solid var(--border-dark);
            border-radius: 12px; 
            background: var(--dark-bg); 
            color: var(--text-primary-dark);
            font-size: 13px; 
            transition: all 0.2s; 
            font-family: inherit;
        }
        body.light input, 
        body.light textarea, 
        body.light select { 
            background: #ffffff; 
            border-color: var(--border-light); 
            color: var(--text-primary-light); 
        }
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
        }
        input[type="color"] { 
            height: 40px; 
            padding: 4px; 
            cursor: pointer; 
            border-radius: 8px; 
            background: transparent;
            border: 2px solid var(--border-dark);
        }
        body.light input[type="color"] { border-color: var(--border-light); }
        input[type="range"] { cursor: pointer; height: 6px; }
       
        .slider-container { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin: 8px 0; 
        }
        .slider-value { 
            font-size: 12px; 
            color: var(--text-secondary-dark); 
            min-width: 40px; 
            text-align: center; 
            font-weight: 500; 
        }
        body.light .slider-value { color: var(--text-secondary-light); }
       
        .btn {
            display: inline-flex; 
            align-items: center; 
            gap: 6px;
            margin: 6px 4px; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 12px;
            background: var(--primary); 
            color: white; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 13px; 
            transition: all 0.2s; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            text-decoration: none;
        }
        .btn:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 16px rgba(0,0,0,0.2); 
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
        }
        .btn-primary { background: var(--success); }
        .btn-secondary { background: var(--secondary); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-large { padding: 16px 24px; font-size: 14px; }
       
        .progress-container { 
            margin: 16px 0; 
            height: 10px; 
            background: rgba(71, 85, 105, 0.3); 
            border-radius: 5px; 
            overflow: hidden; 
        }
        body.light .progress-container { background: rgba(209, 213, 219, 0.3); }
        .progress-bar { 
            height: 100%; 
            width: 0; 
            background: var(--success); 
            transition: width 0.3s ease; 
            border-radius: 5px; 
        }
       
        .status-text {
            margin: 16px 0; 
            padding: 16px; 
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px; 
            border-left: 4px solid #3b82f6; 
            font-size: 13px;
            line-height: 1.5; 
            animation: pulse 2s infinite;
            color: var(--text-primary-dark);
        }
        body.light .status-text {
            background: rgba(59, 130, 246, 0.05);
            color: var(--text-primary-light);
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
       
        .results { 
            display: grid; 
            gap: 20px; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        }
        .result-item {
            background: var(--panel-bg-dark); 
            border-radius: 16px; 
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .3); 
            transition: all 0.3s;
            border: 1px solid rgba(59, 130, 246, 0.2); 
            position: relative; 
            overflow: hidden;
            color: var(--text-primary-dark);
        }
        body.light .result-item {
            background: var(--panel-bg-light);
            border-color: rgba(59, 130, 246, 0.1);
            color: var(--text-primary-light);
        }
        .result-item::before {
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 4px;
            background: var(--success);
        }
        .result-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 12px 40px rgba(0, 0, 0, .4); 
        }
        .result-item img { 
            max-width: 100%; 
            border-radius: 12px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.3); 
        }
        .result-meta { 
            margin: 12px 0; 
            font-size: 12px; 
            color: var(--text-secondary-dark); 
        }
        body.light .result-meta { color: var(--text-secondary-light); }
        .result-sequence {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin: 12px 0;
            font-size: 12px;
            color: #10b981;
        }
       
        .preview { 
            text-align: center; 
            position: relative; 
        }
        .preview canvas { 
            max-width: 100%; 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, .4); 
            border: 3px solid transparent; 
        }
        .preview-info { 
            position: absolute; 
            bottom: 10px; 
            right: 10px; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
        }
       
        .tab-buttons {
            display: flex; 
            gap: 4px; 
            margin: 20px 0; 
            background: rgba(71, 85, 105, 0.2);
            border-radius: 16px; 
            padding: 4px; 
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }
        body.light .tab-buttons { background: rgba(209, 213, 219, 0.2); }
        .tab-btn {
            flex: 1; 
            padding: 14px 12px; 
            border: none; 
            border-radius: 12px;
            background: transparent; 
            color: var(--text-secondary-dark); 
            cursor: pointer;
            font-size: 14px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            position: relative;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
        }
        body.light .tab-btn { color: var(--text-secondary-light); }
        .tab-btn.active {
            background: var(--primary); 
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3); 
            transform: translateY(-2px);
        }
       
        .tab-content { display: none; animation: slideIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes slideIn { 
            from { opacity: 0; transform: translateX(20px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
       
        .csv-section { position: relative; margin: 20px 0; }
        .csv-container { 
            position: relative; 
            background: rgba(30, 41, 59, 0.3); 
            border-radius: 16px; 
            padding: 20px; 
            border: 2px dashed var(--border-dark); 
            transition: all 0.2s; 
            min-height: 160px;
            display: flex;
            flex-direction: column;
        }
        body.light .csv-container { 
            background: rgba(248, 250, 252, 0.5); 
            border-color: var(--border-light); 
        }
        .csv-container.dragover { 
            border-color: #3b82f6; 
            background: rgba(59, 130, 246, 0.05); 
            transform: scale(1.02); 
        }
        .csv-textarea { 
            min-height: 140px; 
            resize: vertical; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            line-height: 1.4; 
            color: var(--text-primary-dark);
            flex: 1;
        }
        body.light .csv-textarea { color: var(--text-primary-light); }
        .csv-textarea.minimized { 
            min-height: 50px !important; 
            max-height: 50px !important; 
            overflow: hidden !important; 
        }
        .csv-toggle {
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: var(--secondary);
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px;
            font-size: 16px; 
            cursor: pointer; 
            transition: all 0.2s; 
            z-index: 10;
        }
        .csv-toggle:hover { 
            background: var(--primary); 
            transform: scale(1.1); 
        }
        .csv-toggle.minimized { background: var(--danger); }
       
        .csv-example {
            background: rgba(16, 185, 129, 0.1); 
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px; 
            padding: 16px; 
            margin: 12px 0; 
            font-size: 12px;
            color: #10b981; 
            line-height: 1.6; 
            font-family: 'Courier New', monospace;
        }
        body.light .csv-example { 
            background: rgba(16, 185, 129, 0.05); 
            color: #166534; 
            border-color: rgba(16, 185, 129, 0.2); 
        }
        .csv-format-guide {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            font-size: 12px;
        }
        body.light .csv-format-guide {
            background: rgba(59, 130, 246, 0.05);
            border-color: rgba(59, 130, 246, 0.2);
        }
       
        .preset-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.15); 
            border-radius: 16px;
            padding: 20px; 
            margin: 20px 0; 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        body.light .preset-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.02), rgba(16, 185, 129, 0.02));
            border-color: rgba(59, 130, 246, 0.1);
        }
        .preset-btn {
            padding: 12px 18px; 
            font-size: 13px; 
            font-weight: 600; 
            border-radius: 10px;
            border: none; 
            cursor: pointer; 
            transition: all 0.2s; 
            min-width: 120px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px;
            color: white;
        }
        .preset-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        .preset-story { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .preset-marketing { background: linear-gradient(135deg, #10b981, #059669); }
        .preset-education { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .preset-motivation { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .preset-professional { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
       
        .control-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        .control-group { 
            background: rgba(71, 85, 105, 0.1); 
            padding: 20px; 
            border-radius: 16px; 
            border: 1px solid rgba(71, 85, 105, 0.2); 
        }
        body.light .control-group { 
            background: rgba(248, 250, 252, 0.5); 
            border-color: rgba(209, 213, 219, 0.5); 
        }
       
        .btn-group {
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin: 20px 0;
            padding: 20px; 
            background: rgba(71, 85, 105, 0.1); 
            border-radius: 16px;
            justify-content: center;
        }
        body.light .btn-group { background: rgba(248, 250, 252, 0.3); }
       
        .file-upload { position: relative; display: inline-block; margin: 8px; }
        .file-upload input[type=file] { position: absolute; left: -9999px; }
        .file-upload-label {
            display: inline-flex; 
            align-items: center; 
            gap: 8px;
            padding: 12px 20px; 
            background: var(--secondary); 
            color: white;
            border-radius: 12px; 
            cursor: pointer; 
            transition: all 0.2s; 
            font-weight: 500;
        }
        .file-upload-label:hover { 
            background: var(--primary); 
            transform: translateY(-1px); 
        }
       
        .sequence-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .sequence-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .sequence-item img {
            width: 100%;
            height: 280px;
            object-fit: cover;
        }
        .sequence-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
       
        .text-preview {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.4;
            max-height: 100px;
            overflow-y: auto;
            margin-top: 8px;
        }
        .text-preview strong { color: #3b82f6; }
       
        /* Story Templates */
        .template-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
        }
        body.light .template-section {
            background: rgba(139, 92, 246, 0.02);
            border-color: rgba(139, 92, 246, 0.1);
        }
        .template-btn {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .template-description {
            font-size: 12px;
            color: var(--text-secondary-dark);
            margin-top: 8px;
        }
        body.light .template-description { color: var(--text-secondary-light); }
       
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .top-row { flex-direction: column; gap: 16px; }
            .panel { min-width: unset; padding: 16px; }
            .tab-buttons { flex-direction: column; margin: 12px 0; }
            .btn-group { flex-direction: column; align-items: stretch; }
            .control-grid { grid-template-columns: 1fr; }
            h1 { font-size: 24px; }
            .sequence-preview { grid-template-columns: 1fr; }
        }
       
        #themeToggle, #goToTop {
            position: fixed; 
            z-index: 1000; 
            border: none; 
            border-radius: 50%;
            width: 48px; 
            height: 48px; 
            display: flex; 
            align-items: center;
            justify-content: center; 
            font-size: 16px; 
            cursor: pointer;
            transition: all 0.2s; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #themeToggle { 
            top: 20px; 
            right: 20px; 
            background: var(--secondary); 
            color: white; 
        }
        #themeToggle:hover { 
            background: var(--primary); 
            transform: scale(1.1); 
        }
        #goToTop { 
            bottom: 20px; 
            right: 20px; 
            background: var(--primary); 
            color: white; 
            display: none; 
        }
        #goToTop:hover { 
            background: var(--success); 
            transform: scale(1.1); 
        }
       
        .loading { 
            display: inline-block; 
            width: 16px; 
            height: 16px; 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top-color: white; 
            animation: spin 1s ease-in-out infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
       
        .success { animation: success 0.6s ease; }
        @keyframes success { 
            0% { transform: scale(0.8); opacity: 0; } 
            50% { transform: scale(1.05); } 
            100% { transform: scale(1); opacity: 1; } 
        }
        
        .story-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 16px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 12px;
            text-align: center;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #10b981;
            display: block;
        }
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        body.light .stat-label { color: var(--text-secondary-light); }
    </style>
</head>
<body class="dark">
    <div class="container">
        <div class="header">
            <h1>🎬 Video Story Studio</h1>
            <p class="subtitle">Create professional video-style image sequences with long-form text overlays</p>
        </div>
       
        <div class="top-row">
            <div class="panel preview-panel">
                <h2>🔍 Live Preview</h2>
                <div class="preview">
                    <canvas id="previewCanvas"></canvas>
                    <div class="preview-info" id="previewInfo">
                        <div>Ready</div>
                        <div id="previewDimensions">-</div>
                    </div>
                </div>
                <div class="story-stats" id="storyStats" style="display: none;">
                    <div class="stat-item">
                        <span class="stat-number" id="totalScenes">0</span>
                        <span class="stat-label">Scenes</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="totalWords">0</span>
                        <span class="stat-label">Words</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="totalChars">0</span>
                        <span class="stat-label">Characters</span>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; font-size: 12px; text-align: center; color: #10b981;">
                    <strong>🎯 Pro Tip:</strong> Use <code>\n</code> for line breaks • <code>**bold**</code> for emphasis • Export as video sequence
                </div>
            </div>
           
            <div class="panel control-panel">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="story">
                        <span>📖</span> Story Builder
                    </button>
                    <button class="tab-btn" data-tab="title">
                        <span>🎨</span> Title Design
                    </button>
                    <button class="tab-btn" data-tab="detail">
                        <span>📝</span> Detail Design
                    </button>
                    <button class="tab-btn" data-tab="export">
                        <span>📦</span> Export
                    </button>
                </div>
                 
                <!-- Story Builder Tab -->
                <div id="story-tab" class="tab-content active">
                    <div class="csv-section">
                        <div class="csv-container" id="csvDropZone">
                            <label>📁 Story Content</label>
                            <textarea id="csvInput" class="csv-textarea" placeholder="Paste your story content here or drag & drop a CSV file...&#10;&#10;Format: image_url,scene_title,scene_description&#10;Supports long multi-line text with \n for line breaks&#10;&#10;Example:&#10;https://example.com/scene1.jpg,Chapter 1: The Beginning,This is the first scene of our story.\n\nIt sets the stage for everything to come.\n\nDetailed descriptions work great for immersive storytelling." rows="10"></textarea>
                            <button class="csv-toggle" id="csvToggle">−</button>
                           
                            <div style="margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                <div class="file-upload">
                                    <input type="file" id="csvFile" accept=".csv,.txt">
                                    <label for="csvFile" class="file-upload-label">
                                        📁 Upload Story
                                    </label>
                                </div>
                                <button class="btn btn-secondary" id="clearCsvBtn">🗑️ Clear Story</button>
                                <button class="btn btn-primary" id="loadTemplateBtn">📚 Load Template</button>
                            </div>
                           
                            <div class="csv-format-guide">
                                <strong>📋 Story Format Guide:</strong><br>
                                <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-size: 11px;">image_url,scene_title,scene_description</code><br>
                                • Use <code>\n</code> for line breaks<br>
                                • Use <code>**bold text**</code> for emphasis<br>
                                • Each row = 1 scene in your video sequence
                            </div>
                           
                            <div class="csv-example">
                                <strong>💡 Quick Start Templates:</strong>
                                <button class="template-btn" onclick="loadStoryTemplate('motivational')">💪 Motivational Journey</button>
                                <div class="template-description">5-scene transformation story</div>
                                <button class="template-btn" onclick="loadStoryTemplate('business')">💼 Business Success</button>
                                <div class="template-description">6-scene entrepreneurial journey</div>
                                <button class="template-btn" onclick="loadStoryTemplate('product')">📱 Product Launch</button>
                                <div class="template-description">4-scene product showcase</div>
                            </div>
                        </div>
                    </div>
                   
                    <div class="sequence-preview" id="sequencePreview"></div>
                </div>
                
                <!-- Title Design Tab -->
                <div id="title-tab" class="tab-content">
                    <div class="control-group">
                        <h3>🎨 Title Typography</h3>
                        <div class="control-grid">
                            <div>
                                <label>📏 Size</label>
                                <div class="slider-container">
                                    <input type="range" id="titleSize" min="24" max="120" value="48">
                                    <span class="slider-value" id="titleSizeValue">48px</span>
                                </div>
                                <label>🎨 Text Color</label>
                                <input type="color" id="titleColor" value="#ffffff">
                                <label>✨ Glow Color</label>
                                <input type="color" id="titleGlowColor" value="#ff6b6b">
                            </div>
                            <div>
                                <label>🌟 Glow Intensity</label>
                                <div class="slider-container">
                                    <input type="range" id="titleShadowBlur" min="0" max="50" value="15">
                                    <span class="slider-value" id="titleShadowBlurValue">15px</span>
                                </div>
                                <label>🎀 Font Family</label>
                                <select id="titleFontFamily">
                                    <option value="Playfair Display">✨ Playfair Display</option>
                                    <option value="Bebas Neue">⚡ Bebas Neue</option>
                                    <option value="Oswald">📢 Oswald</option>
                                    <option value="Dancing Script">💌 Dancing Script</option>
                                    <option value="Great Vibes">🌹 Great Vibes</option>
                                    <option value="Inter">📝 Inter</option>
                                    <option value="Roboto Slab">📚 Roboto Slab</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <h3>📐 Title Layout</h3>
                        <div class="control-grid">
                            <div>
                                <label>📍 Position</label>
                                <div class="slider-container">
                                    <input type="range" id="titleSlider" min="-200" max="300" value="-50">
                                    <span class="slider-value" id="titleSliderValue">-50px</span>
                                </div>
                                <label>📐 Alignment</label>
                                <select id="titleAlign">
                                    <option value="center">↔️ Center</option>
                                    <option value="left">⬅️ Left</option>
                                    <option value="right">➡️ Right</option>
                                </select>
                            </div>
                            <div>
                                <label>🖋️ Stroke Color</label>
                                <input type="color" id="titleBorderColor" value="#ffffff">
                                <label>📏 Stroke Width</label>
                                <div class="slider-container">
                                    <input type="range" id="titleBorderWidth" min="0" max="8" value="1">
                                    <span class="slider-value" id="titleBorderWidthValue">1px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <h3>🎨 Title Background</h3>
                        <div class="control-grid">
                            <div>
                                <label>🎨 Gradient Start</label>
                                <input type="color" id="titleBg1" value="#00000080">
                                <label>🎨 Gradient End</label>
                                <input type="color" id="titleBg2" value="#00000040">
                                <label>🌫️ Opacity</label>
                                <div class="slider-container">
                                    <input type="range" id="titleBgOpacity" min="0" max="100" value="85">
                                    <span class="slider-value" id="titleBgOpacityValue">85%</span>
                                </div>
                            </div>
                            <div>
                                <label>🔄 Corner Radius</label>
                                <div class="slider-container">
                                    <input type="range" id="titleCornerRadius" min="0" max="30" value="15">
                                    <span class="slider-value" id="titleCornerRadiusValue">15px</span>
                                </div>
                                <label>📏 Padding</label>
                                <div class="slider-container">
                                    <input type="range" id="titlePadding" min="8" max="40" value="20">
                                    <span class="slider-value" id="titlePaddingValue">20px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detail Design Tab -->
                <div id="detail-tab" class="tab-content">
                    <div class="control-group">
                        <h3>📝 Detail Typography (Long Text Optimized)</h3>
                        <div class="control-grid">
                            <div>
                                <label>📏 Size</label>
                                <div class="slider-container">
                                    <input type="range" id="detailSize" min="14" max="100" value="20">
                                    <span class="slider-value" id="detailSizeValue">20px</span>
                                </div>
                                <label>🎨 Text Color</label>
                                <input type="color" id="detailColor" value="#f8fafc">
                                <label>✨ Glow Color</label>
                                <input type="color" id="detailGlowColor" value="#4f46e5">
                            </div>
                            <div>
                                <label>🌟 Glow Intensity</label>
                                <div class="slider-container">
                                    <input type="range" id="detailShadowBlur" min="0" max="30" value="8">
                                    <span class="slider-value" id="detailShadowBlurValue">8px</span>
                                </div>
                                <label>🎀 Font Family</label>
                                <select id="detailFontFamily">
                                    <option value="Inter">📝 Inter (Modern)</option>
                                    <option value="Lora">📚 Lora (Readable)</option>
                                    <option value="Poppins">🛡️ Poppins (Clean)</option>
                                    <option value="Montserrat">⚡ Montserrat</option>
                                    <option value="Roboto Slab">📖 Roboto Slab</option> 
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <h3>📐 Detail Layout</h3>
                        <div class="control-grid">
                            <div>
                                <label>📍 Position</label>
                                <div class="slider-container">
                                    <input type="range" id="detailSlider" min="-600" max="200" value="50">
                                    <span class="slider-value" id="detailSliderValue">50px</span>
                                </div>
                                <label>📐 Alignment</label>
                                <select id="detailAlign">
                                  <option value="center">↔️ Center</option>
                                    <option value="left">⬅️ Left</option>
                                    
                                    <option value="right">➡️ Right</option>
                                </select>
                                <label>📏 Line Height</label>
                                <div class="slider-container">
                                    <input type="range" id="detailLineHeight" min="1.2" max="2.0" step="0.1" value="1.6">
                                    <span class="slider-value" id="detailLineHeightValue">1.6x</span>
                                </div>
                            </div>
                            <div>
                                <label>🖋️ Stroke Color</label>
                                <input type="color" id="detailBorderColor" value="#e2e8f0">
                                <label>📏 Stroke Width</label>
                                <div class="slider-container">
                                    <input type="range" id="detailBorderWidth" min="0" max="4" value="0">
                                    <span class="slider-value" id="detailBorderWidthValue">0px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <h3>🎨 Detail Background</h3>
                        <div class="control-grid">
                            <div>
                                <label>🎨 Gradient Start</label>
                                <input type="color" id="detailBg1" value="#00000060">
                                <label>🎨 Gradient End</label>
                                <input type="color" id="detailBg2" value="#00000030">
                                <label>🌫️ Opacity</label>
                                <div class="slider-container">
                                    <input type="range" id="detailBgOpacity" min="0" max="100" value="90">
                                    <span class="slider-value" id="detailBgOpacityValue">90%</span>
                                </div>
                            </div>
                            <div>
                                <label>🔄 Corner Radius</label>
                                <div class="slider-container">
                                    <input type="range" id="detailCornerRadius" min="0" max="20" value="10">
                                    <span class="slider-value" id="detailCornerRadiusValue">10px</span>
                                </div>
                                <label>📏 Padding</label>
                                <div class="slider-container">
                                    <input type="range" id="detailPadding" min="10" max="40" value="25">
                                    <span class="slider-value" id="detailPaddingValue">25px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Export Tab -->
                <div id="export-tab" class="tab-content">
                    <div class="control-group">
                        <h3>📦 Export Settings</h3>
                        <div class="control-grid">
                            <div>
                                <label>📐 Output Format</label>
                                <select id="outputSize">
                                    <option value="reel">📱 1080×1920 (Video Portrait)</option>
                                    <option value="youtube">📺 1920×1080 (Landscape)</option>
                                    <option value="square">⬜ 1080×1080 (Square)</option>
                                    <option value="portrait">📖 1080×1350 (Static Portrait)</option>
                                </select>
                            </div>
                            <div>
                                <label>🎨 Quality</label>
                                <select id="outputQuality">
                                    <option value="1.0">✨ Highest Quality (1.0)</option>
                                    <option value="0.95">⚡ High Quality (0.95)</option>
                                    <option value="0.9">🚀 Standard (0.9)</option>
                                </select>
                            </div>
                            <div>
                                <label>🏷️ File Prefix</label>
                                <input type="text" id="filePrefix" placeholder="story-sequence" value="video-story">
                            </div>
                            <div>
                                <label>📁 Output Folder</label>
                                <input type="text" id="outputFolder" placeholder="my-story-sequence" value="story-pack">
                            </div>
                        </div>
                    </div>
                   
                    <div class="btn-group">
                        <button class="btn btn-primary btn-large" id="generateAllBtn">
                            <span>🚀</span> Generate Full Sequence
                        </button>
                        <button class="btn btn-primary btn-large" id="previewAllBtn">
                            <span>👁️</span> Preview All Scenes
                        </button>
                        <button class="btn btn-secondary btn-large" id="exportZipBtn">
                            <span>📦</span> Export ZIP Package
                        </button>
                        <button class="btn btn-secondary btn-large" id="exportVideoBtn">
                            <span>🎥</span> Export Video Story
                        </button>
                        <button class="btn btn-danger" id="clearResultsBtn">
                            <span>🗑️</span> Clear All
                        </button>
                    </div>
                   
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="status-text" id="statusText">
                        🎬 Ready to create your video story! Paste your content above or load a template
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel results-panel" id="resultsPanel" style="width: 100%; max-width: 1200px; margin-top: 24px; display: none;">
            <h2>🎉 Generated Story Sequence <span id="resultsCount" style="font-size: 14px; color: var(--text-secondary-dark);">(0 scenes)</span></h2>
            <div id="results" class="results"></div>
            <div style="text-align: center; margin-top: 24px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                <strong>✅ Complete video story sequence ready!</strong><br>
                <small style="color: var(--text-secondary-dark);">Optimized for social media • Professional quality • Ready to share</small>
            </div>
        </div>
    </div>
    
    <button id="themeToggle">🌙</button>
    <button id="goToTop">↑</button>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
   
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Constants
            const DEFAULT_SETTINGS = {
                titleSize: 48, titleColor: '#ffffff', titleGlowColor: '#ff6b6b', titleShadowBlur: 15,
                titleBg1: '#00000080', titleBg2: '#00000040', titleBgOpacity: 85, titleBorderColor: '#ffffff',
                titleBorderWidth: 1, titleCornerRadius: 15, titlePadding: 20, titleSlider: -50, titleAlign: 'center',
                titleFontFamily: 'Playfair Display',
               
                detailSize: 20, detailColor: '#f8fafc', detailGlowColor: '#4f46e5', detailShadowBlur: 8,
                detailBg1: '#00000060', detailBg2: '#00000030', detailBgOpacity: 90, detailBorderColor: '#e2e8f0',
                detailBorderWidth: 0, detailCornerRadius: 10, detailPadding: 25, detailSlider: 50,
                detailAlign: 'left', detailLineHeight: 1.6, detailFontFamily: 'Inter',
               
                outputSize: 'reel', outputQuality: 0.95, filePrefix: 'video-story'
            };
            
            const SIZE_PRESETS = {
                reel: [1080, 1920], youtube: [1920, 1080], square: [1080, 1080],
                portrait: [1080, 1350]
            };
            
            const MAX_PREVIEW_SIZE = 600;
            const DEBOUNCE_DELAY = 200;
            
            // DOM Elements
            const elements = {
                previewCanvas: document.getElementById('previewCanvas'),
                results: document.getElementById('results'),
                resultsPanel: document.getElementById('resultsPanel'),
                resultsCount: document.getElementById('resultsCount'),
                progressBar: document.getElementById('progressBar'),
                statusText: document.getElementById('statusText'),
                previewInfo: document.getElementById('previewInfo'),
                previewDimensions: document.getElementById('previewDimensions'),
                csvInput: document.getElementById('csvInput'),
                csvFile: document.getElementById('csvFile'),
                csvDropZone: document.getElementById('csvDropZone'),
                itemCount: document.getElementById('itemCount'),
                sequencePreview: document.getElementById('sequencePreview'),
                storyStats: document.getElementById('storyStats'),
                totalScenes: document.getElementById('totalScenes'),
                totalWords: document.getElementById('totalWords'),
                totalChars: document.getElementById('totalChars'),
                inputs: document.querySelectorAll('input, select, textarea'),
                buttons: {
                    generateAll: document.getElementById('generateAllBtn'),
                    previewAll: document.getElementById('previewAllBtn'),
                    exportZip: document.getElementById('exportZipBtn'),
                    exportVideo: document.getElementById('exportVideoBtn'),
                    clearResults: document.getElementById('clearResultsBtn'),
                    loadTemplate: document.getElementById('loadTemplateBtn'),
                    clearCsv: document.getElementById('clearCsvBtn')
                }
            };
            
            const ctx = elements.previewCanvas.getContext('2d');
            const themeToggle = document.getElementById('themeToggle');
            const goToTop = document.getElementById('goToTop');
            const csvToggle = document.getElementById('csvToggle');
            
            // State
            const imageCache = new Map();
            let isCsvMinimized = false;
            let currentStoryData = [];
            let currentPreviewIndex = 0;
            
            // Make functions globally accessible
            window.loadStoryTemplate = loadStoryTemplate;
            
            // Tab System
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            function switchTab(tabName) {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');
                if (tabName === 'story') updateSequencePreview();
            }
            
            // CSV Management
            function toggleCsv() {
                isCsvMinimized = !isCsvMinimized;
                const csvInput = elements.csvInput;
                if (isCsvMinimized) {
                    csvInput.classList.add('minimized');
                    csvToggle.textContent = '+';
                    csvToggle.classList.add('minimized');
                } else {
                    csvInput.classList.remove('minimized');
                    csvToggle.textContent = '−';
                    csvToggle.classList.remove('minimized');
                }
            }
            
            elements.csvFile.addEventListener('change', loadCsvFile);
            
            function loadCsvFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    elements.csvInput.value = e.target.result;
                    parseStoryData();
                    elements.statusText.innerHTML = `
                        ✅ <strong>Story Loaded:</strong> ${file.name}
                        <span style="color: #10b981;">(${currentStoryData.length} scenes detected)</span>
                    `;
                    elements.csvFile.value = '';
                };
                reader.readAsText(file);
            }
            
            function clearCsv() {
                elements.csvInput.value = '';
                currentStoryData = [];
                updateSequencePreview();
                elements.statusText.innerHTML = '🗑️ <strong>Story Cleared</strong> - Ready for new content';
                elements.csvFile.value = '';
            }
            
            // Story Templates
            function loadStoryTemplate(templateType) {
                const templates = {
                    motivational: `https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1080&h=1920&fit=crop,Your Transformation Begins,This is where your journey starts.\n\nEvery great achievement begins with a single step.\n\n**Are you ready to take that step today?**\n\nThe path ahead is challenging but incredibly rewarding.\n\n🚀 Your first mission: believe in yourself completely.,https://images.unsplash.com/photo-1516589178581-6cd7833ae3b7?w=1080&h=1920&fit=crop,Building Momentum,Day by day, you're becoming unstoppable.\n\n**Daily habits create extraordinary results.**\n\n• Wake up with purpose\n• Move your body daily\n• Feed your mind with positivity\n• Take consistent action\n\nSmall wins compound into massive success.\n\n💪 Keep pushing forward!,https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=1080&h=1920&fit=crop,Breaking Through,The resistance is real, but so is your determination.\n\n**This is where champions are made.**\n\nWhen it gets tough, remember why you started.\n\nYour future self is cheering you on.\n\n🌟 You're closer than you think!,https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1080&h=1920&fit=crop,Peak Performance,You've transformed into someone extraordinary.\n\n**The compound effect is working its magic.**\n\nLook how far you've come!\n\nYour discipline has created freedom.\n\nYour consistency has created excellence.\n\n🎯 You're now unstoppable.,https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1080&h=1920&fit=crop,Legacy Creator,Your transformation inspires everyone around you.\n\n**You've become the person you needed when you started.**\n\nKeep going. Keep growing. Keep inspiring.\n\nThe world needs more people like you.\n\n✨ Your legacy begins now.`,
                    
                    business: `https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1080&h=1920&fit=crop,The Vision,Every great business starts with a bold vision.\n\n**What problem will you solve?**\n\nWho will you serve? How will you serve them better than anyone else?\n\nYour vision is your North Star.\n\n🌟 Write it down. Speak it daily. Live it completely.,https://images.unsplash.com/photo-1552664730-d307ca884978?w=1080&h=1920&fit=crop,Market Research,Success = Understanding your customers deeply.\n\n**Know their pain points. Know their dreams.**\n\n• Survey 100 potential customers\n• Analyze competitors thoroughly\n• Identify unmet needs\n• Validate your solution\n\n**The market always tells the truth.**\n\n📊 Listen carefully.,https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=1080&h=1920&fit=crop,Minimum Viable Product,Launch fast. Learn faster.\n\n**Build the simplest version that solves the core problem.**\n\nDon't aim for perfection. Aim for progress.\n\nGet it in front of real customers.\n\n💡 Their feedback is your gold.,https://images.unsplash.com/photo-1558618047-3c8c76b3a93e?w=1080&h=1920&fit=crop,Scale Strategically,Systems create freedom. Chaos creates stress.\n\n**Document everything. Automate everything.**\n\n• Customer acquisition systems\n• Fulfillment processes\n• Financial tracking\n• Team communication\n\n🔧 Build your machine.,https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=1080&h=1920&fit=crop,Market Domination,Your business is now a well-oiled machine.\n\n**Focus on what got you here, but 10x it.**\n\n• Expand your product line\n• Enter new markets\n• Build strategic partnerships\n• Double down on what works\n\n🚀 The world is waiting.`,
                    
                    product: `https://images.unsplash.com/photo-1558618047-3c8c76b3a93e?w=1080&h=1920&fit=crop,Introducing [Product Name],The solution you've been waiting for.\n\n**Solve [specific problem] once and for all.**\n\nNo more [current pain point]. No more wasted time.\n\nJust pure, simple results.\n\n✨ Experience the difference.,https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=1080&h=1920&fit=crop,How It Works,Three simple steps to transform your [problem area].\n\n**Step 1:** [Simple first step]\n**Step 2:** [Core functionality]\n**Step 3:** [Amazing result]\n\nThat's it. No complicated setup. No steep learning curve.\n\n🎯 Designed for your success.,https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=1080&h=1920&fit=crop,Real Results,Don't just take our word for it.\n\n**See what actually happens:**\n\n• [Specific result 1]\n• [Specific result 2]\n• [Specific result 3]\n• [Transformation achieved]\n\nYour success is guaranteed.\n\n📈 Proven. Tested. Delivered.`
                };
                
                elements.csvInput.value = templates[templateType];
                parseStoryData();
                elements.statusText.innerHTML = `
                    📚 <strong>${templateType.charAt(0).toUpperCase() + templateType.slice(1)} Template Loaded!</strong>
                    <span style="color: #10b981;">(${currentStoryData.length} scenes ready to customize)</span>
                `;
            }
            
            // Story Data Parsing
            function parseStoryData() {
                const lines = elements.csvInput.value.trim().split('\n').filter(line => line.trim());
                currentStoryData = lines.map((line, index) => {
                    const [imageUrl, title, detail] = parseCsvLine(line);
                    return {
                        id: index,
                        imageUrl,
                        title: title || `Scene ${index + 1}`,
                        detail: detail || '',
                        wordCount: detail.split(/\s+/).length,
                        charCount: detail.length
                    };
                }).filter(item => item.imageUrl);
                
                updateSequencePreview();
                updateStoryStats();
            }
            
            function parseCsvLine(line) {
                const parts = line.split(',').map(part => part.trim().replace(/^"|"$/g, ''));
                while (parts.length < 3) parts.push('');
                return parts.slice(0, 3);
            }
            
            function updateSequencePreview() {
                const previewHtml = currentStoryData.map((scene, index) => `
                    <div class="sequence-item">
                        <img src="${scene.imageUrl}" alt="Scene ${index + 1}" 
                             onerror="this.src='https://via.placeholder.com/300x500/1e293b/94a3b8?text=Scene+${index+1}'"
                             loading="lazy" onclick="previewScene(${index})">
                        <div class="sequence-number">Scene ${index + 1}</div>
                        <div class="text-preview">
                            <strong>${scene.title}</strong><br>
                            ${scene.detail.split('\n').slice(0, 3).join('<br>')}...
                        </div>
                    </div>
                `).join('');
                elements.sequencePreview.innerHTML = previewHtml || '<p style="text-align: center; color: var(--text-secondary-dark);">Add your story content above to see the sequence</p>';
                elements.itemCount.textContent = currentStoryData.length;
            }
            
            function updateStoryStats() {
                if (currentStoryData.length === 0) {
                    elements.storyStats.style.display = 'none';
                    return;
                }
                
                const totalWords = currentStoryData.reduce((sum, scene) => sum + scene.wordCount, 0);
                const totalChars = currentStoryData.reduce((sum, scene) => sum + scene.charCount, 0);
                
                elements.totalScenes.textContent = currentStoryData.length;
                elements.totalWords.textContent = totalWords;
                elements.totalChars.textContent = totalChars;
                elements.storyStats.style.display = 'flex';
            }
            
            function previewScene(index) {
                if (index >= currentStoryData.length) return;
                currentPreviewIndex = index;
                updatePreview();
            }
            
            // Settings Management
            function getSettings() {
                return {
                    titleSize: parseFloat(document.getElementById('titleSize').value),
                    titleColor: document.getElementById('titleColor').value,
                    titleGlowColor: document.getElementById('titleGlowColor').value,
                    titleShadowBlur: parseFloat(document.getElementById('titleShadowBlur').value),
                    titleBg1: document.getElementById('titleBg1').value,
                    titleBg2: document.getElementById('titleBg2').value,
                    titleBgOpacity: parseFloat(document.getElementById('titleBgOpacity').value),
                    titleBorderColor: document.getElementById('titleBorderColor').value,
                    titleBorderWidth: parseFloat(document.getElementById('titleBorderWidth').value),
                    titleCornerRadius: parseFloat(document.getElementById('titleCornerRadius').value),
                    titlePadding: parseFloat(document.getElementById('titlePadding').value),
                    titleSlider: parseFloat(document.getElementById('titleSlider').value),
                    titleAlign: document.getElementById('titleAlign').value,
                    titleFontFamily: document.getElementById('titleFontFamily').value,
                   
                    detailSize: parseFloat(document.getElementById('detailSize').value),
                    detailColor: document.getElementById('detailColor').value,
                    detailGlowColor: document.getElementById('detailGlowColor').value,
                    detailShadowBlur: parseFloat(document.getElementById('detailShadowBlur').value),
                    detailBg1: document.getElementById('detailBg1').value,
                    detailBg2: document.getElementById('detailBg2').value,
                    detailBgOpacity: parseFloat(document.getElementById('detailBgOpacity').value),
                    detailBorderColor: document.getElementById('detailBorderColor').value,
                    detailBorderWidth: parseFloat(document.getElementById('detailBorderWidth').value),
                    detailCornerRadius: parseFloat(document.getElementById('detailCornerRadius').value),
                    detailPadding: parseFloat(document.getElementById('detailPadding').value),
                    detailSlider: parseFloat(document.getElementById('detailSlider').value),
                    detailAlign: document.getElementById('detailAlign').value,
                    detailLineHeight: parseFloat(document.getElementById('detailLineHeight').value),
                    detailFontFamily: document.getElementById('detailFontFamily').value,
                   
                    outputSize: document.getElementById('outputSize').value,
                    outputQuality: parseFloat(document.getElementById('outputQuality').value),
                    filePrefix: document.getElementById('filePrefix').value
                };
            }
            
            // Enhanced Text Rendering for Long Content
            function drawTextOverlay(img, title, detail, settings, canvas, scale = 1) {
                const ctx = canvas.getContext('2d');
                const [targetW, targetH] = SIZE_PRESETS[settings.outputSize] || [img.width, img.height];
                canvas.width = targetW * scale;
                canvas.height = targetH * scale;
               
                ctx.clearRect(0, 0, canvas.width, canvas.height);
               
                // Draw background image
                const targetRatio = targetW / targetH;
                const imgRatio = img.width / img.height;
                let sx = 0, sy = 0, sw = img.width, sh = img.height;
               
                if (imgRatio > targetRatio) {
                    sw = img.height * targetRatio;
                    sx = (img.width - sw) / 2;
                } else {
                    sh = img.width / targetRatio;
                    sy = (img.height - sh) / 2;
                }
               
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
                
                const margin = 40 * scale;
                const fontFamily = `"${settings.titleFontFamily}", sans-serif`;
                const detailFontFamily = `"${settings.detailFontFamily}", sans-serif`;
                const lineHeightMultiplier = settings.detailLineHeight || 1.6;
                
                // Title Rendering
                if (title && title.trim()) {
                    ctx.save();
                    ctx.font = `bold ${settings.titleSize * scale}px ${fontFamily}`;
                    ctx.textBaseline = 'top';
                    
                    const titleMetrics = ctx.measureText(title);
                    const titleWidth = titleMetrics.width;
                    const titleHeight = settings.titleSize * scale * 1.2;
                    
                    let titleX = canvas.width / 2;
                    ctx.textAlign = settings.titleAlign;
                    if (settings.titleAlign === 'left') titleX = margin;
                    else if (settings.titleAlign === 'right') titleX = canvas.width - margin;
                    
                    const titleY = margin + settings.titleSlider * scale;
                    const padding = settings.titlePadding * scale;
                    const cornerRadius = settings.titleCornerRadius * scale;
                    const borderWidth = settings.titleBorderWidth * scale;
                    
                    // Title Background
                    if (settings.titleBgOpacity > 0) {
                        const bgX = settings.titleAlign === 'center' ? 
                            titleX - titleWidth/2 - padding : 
                            settings.titleAlign === 'left' ? titleX + padding : titleX - titleWidth - padding;
                        const bgWidth = titleWidth + padding * 2;
                        
                        const gradient = ctx.createLinearGradient(bgX, titleY, bgX + bgWidth, titleY + titleHeight);
                        gradient.addColorStop(0, hexToRgba(settings.titleBg1, settings.titleBgOpacity / 100));
                        gradient.addColorStop(1, hexToRgba(settings.titleBg2, settings.titleBgOpacity / 100));
                       
                        ctx.save();
                        ctx.fillStyle = gradient;
                        drawRoundedRect(bgX, titleY, bgWidth, titleHeight, cornerRadius, ctx);
                        ctx.fill();
                        ctx.restore();
                    }
                    
                    // Title Border & Glow
                    if (borderWidth > 0) {
                        ctx.strokeStyle = settings.titleBorderColor;
                        ctx.lineWidth = borderWidth;
                        ctx.shadowColor = settings.titleGlowColor;
                        ctx.shadowBlur = settings.titleShadowBlur * scale;
                        ctx.strokeText(title, titleX, titleY);
                    }
                    
                    // Title Text
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = settings.titleColor;
                    ctx.fillText(title, titleX, titleY);
                    ctx.restore();
                }
                
                // Detail Rendering - Enhanced for Long Text
                if (detail && detail.trim()) {
                    const lines = detail.split('\n').filter(line => line.trim());
                    if (lines.length > 0) {
                        ctx.save();
                        const lineHeight = settings.detailSize * scale * lineHeightMultiplier;
                        const maxLines = Math.floor((canvas.height * 0.6) / lineHeight);
                        const displayLines = lines.slice(0, maxLines);
                        
                        displayLines.forEach((line, i) => {
                            // Format bold text
                            const formattedLine = line.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                            ctx.font = `${settings.detailSize * scale}px ${detailFontFamily}`;
                            ctx.textBaseline = 'top';
                            
                            const textMetrics = ctx.measureText(line);
                            const textWidth = textMetrics.width;
                            
                            let detailX = canvas.width / 2;
                            ctx.textAlign = settings.detailAlign;
                            if (settings.detailAlign === 'left') detailX = margin;
                            else if (settings.detailAlign === 'right') detailX = canvas.width - margin;
                            
                            const lineY = canvas.height - (displayLines.length - i) * lineHeight - margin + settings.detailSlider * scale;
                            const padding = settings.detailPadding * scale;
                            const cornerRadius = settings.detailCornerRadius * scale;
                            const borderWidth = settings.detailBorderWidth * scale;
                            const textHeight = settings.detailSize * scale * lineHeightMultiplier;
                            
                            // Detail Background per line
                            if (settings.detailBgOpacity > 0) {
                                const bgX = settings.detailAlign === 'center' ? 
                                    detailX - textWidth/2 - padding : 
                                    settings.detailAlign === 'left' ? detailX + padding : detailX - textWidth - padding;
                                const bgWidth = textWidth + padding * 2;
                                
                                const gradient = ctx.createLinearGradient(bgX, lineY, bgX + bgWidth, lineY + textHeight);
                                gradient.addColorStop(0, hexToRgba(settings.detailBg1, settings.detailBgOpacity / 100));
                                gradient.addColorStop(1, hexToRgba(settings.detailBg2, settings.detailBgOpacity / 100));
                               
                                ctx.save();
                                ctx.fillStyle = gradient;
                                drawRoundedRect(bgX, lineY, bgWidth, textHeight, cornerRadius, ctx);
                                ctx.fill();
                                ctx.restore();
                            }
                            
                            // Detail Border & Glow
                            if (borderWidth > 0) {
                                ctx.strokeStyle = settings.detailBorderColor;
                                ctx.lineWidth = borderWidth;
                                ctx.shadowColor = settings.detailGlowColor;
                                ctx.shadowBlur = settings.detailShadowBlur * scale;
                                ctx.strokeText(line, detailX, lineY);
                            }
                            
                            // Detail Text
                            ctx.shadowBlur = 0;
                            ctx.fillStyle = settings.detailColor;
                            ctx.fillText(line, detailX, lineY);
                        });
                        ctx.restore();
                    }
                }
                
                if (scale === 1) {
                    elements.previewDimensions.textContent = `${targetW}×${targetH}px`;
                }
                return canvas.toDataURL('image/png', settings.outputQuality);
            }
            
            function hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            
            function drawRoundedRect(x, y, width, height, radius, ctx) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
               
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.arcTo(x + width, y, x + width, y + height, radius);
                ctx.arcTo(x + width, y + height, x, y + height, radius);
                ctx.arcTo(x, y + height, x, y, radius);
                ctx.arcTo(x, y, x + width, y, radius);
                ctx.closePath();
                ctx.restore();
            }
            
            // Preview System
            const updatePreview = debounce(async () => {
                if (currentStoryData.length === 0) {
                    elements.statusText.innerHTML = `
                        📝 <strong>No Story Content</strong> - 
                        <a href="#" onclick="document.getElementById('csvInput').focus(); return false;" style="color: #3b82f6;">Add scenes</a> or
                        <a href="#" onclick="loadStoryTemplate('motivational'); return false;" style="color: #10b981;">load template</a>
                    `;
                    return;
                }
                
                const currentScene = currentStoryData[currentPreviewIndex] || currentStoryData[0];
                const settings = getSettings();
                
                try {
                    elements.statusText.innerHTML = `
                        ⏳ <strong>Rendering Scene ${currentPreviewIndex + 1}/${currentStoryData.length}...</strong>
                        <span class="loading"></span>
                    `;
                   
                    const img = await loadImage(currentScene.imageUrl);
                    const [targetW, targetH] = SIZE_PRESETS[settings.outputSize] || [img.width, img.height];
                   
                    const scale = Math.min(MAX_PREVIEW_SIZE / Math.max(targetW, targetH), 1);
                    const previewW = targetW * scale;
                    const previewH = targetH * scale;
                   
                    elements.previewCanvas.width = previewW;
                    elements.previewCanvas.height = previewH;
                   
                    await drawTextOverlay(img, currentScene.title, currentScene.detail, settings, elements.previewCanvas, scale);
                   
                    elements.previewInfo.innerHTML = `
                        <div>Scene ${currentPreviewIndex + 1}/${currentStoryData.length}</div>
                        <div>${targetW}×${targetH}px</div>
                    `;
                   
                    elements.statusText.innerHTML = `
                        ✅ <strong>Scene ${currentPreviewIndex + 1} Ready</strong> | 
                        ${currentScene.title} | 
                        <span style="color: #10b981;">${currentScene.wordCount} words</span>
                    `;
                   
                } catch (error) {
                    elements.statusText.innerHTML = `
                        ❌ <strong>Preview Error:</strong> ${error.message}
                        <br><small style="color: var(--text-secondary-dark);">Check your image URL</small>
                    `;
                }
            }, DEBOUNCE_DELAY);
            
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Image Loading
            async function loadImage(src, retryCount = 0) {
                if (imageCache.has(src)) return imageCache.get(src);
               
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                   
                    const timeout = setTimeout(() => reject(new Error('Image load timeout')), 10000);
                   
                    img.onload = () => {
                        clearTimeout(timeout);
                        imageCache.set(src, img);
                        resolve(img);
                    };
                   
                    img.onerror = () => {
                        clearTimeout(timeout);
                        if (retryCount < 2) {
                            setTimeout(() => loadImage(src, retryCount + 1), 1000);
                        } else {
                            reject(new Error(`Failed to load: ${src}`));
                        }
                    };
                   
                    img.src = src + (retryCount > 0 ? `?retry=${retryCount}` : '');
                });
            }
            
            // Generation Functions
            async function generateAll() {
                if (currentStoryData.length === 0) return;
               
                elements.buttons.generateAll.disabled = true;
                elements.resultsPanel.style.display = 'block';
                elements.results.innerHTML = '';
                const settings = getSettings();
                const timestamp = new Date().toISOString().slice(0, 10);
               
                elements.statusText.innerHTML = `
                    🚀 <strong>Generating Story Sequence</strong> ${currentStoryData.length} scenes...
                    <div style="margin-top: 8px;"><span class="loading"></span></div>
                `;
               
                let successCount = 0;
                const results = [];
               
                for (let i = 0; i < currentStoryData.length; i++) {
                    const scene = currentStoryData[i];
                    const progress = ((i + 1) / currentStoryData.length) * 100;
                   
                    elements.progressBar.style.width = `${progress}%`;
                    elements.statusText.innerHTML = `
                        🚀 <strong>Scene ${i + 1}/${currentStoryData.length}</strong> - ${scene.title.substring(0, 30)}...
                        <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary-dark);">
                            ${Math.round(progress)}% • ${scene.wordCount} words
                        </div>
                    `;
                   
                    try {
                        const img = await loadImage(scene.imageUrl);
                        const canvas = document.createElement('canvas');
                        const dataUrl = await drawTextOverlay(img, scene.title, scene.detail, settings, canvas, 1);
                       
                        const filename = `${settings.filePrefix}_${String(i + 1).padStart(2, '0')}_${timestamp}.png`;
                       
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result-item';
                        resultDiv.innerHTML = `
                            <div class="result-meta">
                                <strong>Scene ${i + 1}: ${scene.title}</strong> •
                                ${SIZE_PRESETS[settings.outputSize]?.join('×') || `${img.width}×${img.height}`}px •
                                ${scene.wordCount} words
                            </div>
                            <img src="${dataUrl}" alt="Scene ${i + 1}" loading="lazy">
                            <div style="margin: 16px 0; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                <a class="btn btn-primary" href="${dataUrl}" download="${filename}">💾 Download</a>
                                <button class="btn btn-secondary" onclick="shareScene('${dataUrl}', '${filename}', ${i + 1})">📤 Share</button>
                                <button class="btn btn-warning" onclick="previewScene(${i})">👁️ Preview</button>
                            </div>
                        `;
                       
                        results.push({ element: resultDiv, dataUrl, filename, sceneIndex: i });
                        elements.results.appendChild(resultDiv);
                        successCount++;
                       
                    } catch (error) {
                        console.error(`Failed scene ${i + 1}:`, error);
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'result-item';
                        errorDiv.style.borderLeft = '4px solid #ef4444';
                        errorDiv.innerHTML = `
                            <div class="result-meta" style="color: #ef4444;">
                                <strong>❌ Scene ${i + 1} Failed</strong> • Image Error
                            </div>
                            <div style="color: var(--text-secondary-dark); font-size: 12px;">${error.message}</div>
                        `;
                        elements.results.appendChild(errorDiv);
                    }
                }
               
                elements.resultsCount.textContent = `(${successCount} scenes)`;
                elements.progressBar.style.width = '100%';
               
                elements.statusText.innerHTML = `
                    🎉 <strong>Story Sequence Complete!</strong> Generated ${successCount}/${currentStoryData.length} scenes
                    <br><small><a href="#" onclick="scrollToResults()" style="color: #3b82f6;">👇 View Sequence</a> |
                    <a href="#" onclick="exportStoryZip(${JSON.stringify(results)})" style="color: #10b981;">📦 Export All</a></small>
                `;
               
                scrollToResults();
                elements.buttons.generateAll.disabled = false;
            }
            
            async function previewAll() {
                if (currentStoryData.length === 0) return;
                
                elements.statusText.innerHTML = '👁️ <strong>Preview Mode:</strong> Click any scene thumbnail to view';
                currentPreviewIndex = 0;
                updatePreview();
            }
            
            // Export Functions
            async function exportStoryZip(results) {
                if (!results || results.length === 0) return;
               
                const zip = new JSZip();
                const settings = getSettings();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const packName = `${settings.filePrefix}_complete-story_${timestamp}`;
               
                elements.statusText.innerHTML = '📦 <strong>Creating Story Package...</strong> <span class="loading"></span>';
               
                results.forEach((result) => {
                    const base64Data = result.dataUrl.split(',')[1];
                    zip.file(result.filename, base64Data, { base64: true });
                });
               
                // Add story data file
                zip.file('story-data.json', JSON.stringify({
                    scenes: currentStoryData,
                    settings: settings,
                    generated: new Date().toISOString(),
                    totalScenes: results.length
                }, null, 2));
               
                // Add readme
                zip.file('README.txt', `Video Story Sequence Generated
==========================

Scenes: ${results.length}
Generated: ${new Date().toLocaleString()}
Format: ${settings.outputSize}

Instructions:
1. Import into video editor (Premiere, Final Cut, etc.)
2. Add transitions between scenes
3. Add background music
4. Export as MP4 for social media

Professional Tip: Use 2-3 second transitions for smooth storytelling flow.
`);
               
                try {
                    const content = await zip.generateAsync({ type: 'blob' });
                    saveAs(content, `${packName}.zip`);
                    elements.statusText.innerHTML = `
                        📦 <strong>Story Package Ready!</strong> ${results.length} scenes exported
                        <br><small>Downloaded: <strong>${packName}.zip</strong> (includes story data & instructions)</small>
                    `;
                } catch (error) {
                    elements.statusText.innerHTML = `❌ <strong>Export Failed:</strong> ${error.message}`;
                }
            }
            
            async function exportVideoStory() {
                // This would integrate with a video creation API
                // For now, we'll create a ZIP with sequencing info
                await exportStoryZip(elements.results.children);
                elements.statusText.innerHTML = `
                    🎥 <strong>Video Story Package Ready!</strong>
                    <br><small>Import ZIP into your video editor • Add transitions & music • Export as MP4</small>
                `;
            }
            
            function shareScene(dataUrl, filename, sceneNumber) {
                const shareText = `Check out Scene ${sceneNumber} from my video story!`;
                if (navigator.share) {
                    navigator.share({
                        title: `Video Story - Scene ${sceneNumber}`,
                        text: shareText,
                        url: dataUrl
                    });
                } else {
                    downloadImage(dataUrl, filename);
                }
            }
            
            function downloadImage(dataUrl, filename) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function scrollToResults() {
                elements.resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // UI Updates
            function updateSliderValues() {
                const sliders = {
                    titleSize: 'px', detailSize: 'px', titleShadowBlur: 'px', detailShadowBlur: 'px',
                    titleSlider: 'px', detailSlider: 'px', titleBgOpacity: '%', detailBgOpacity: '%',
                    titleBorderWidth: 'px', detailBorderWidth: 'px', titleCornerRadius: 'px',
                    detailCornerRadius: 'px', titlePadding: 'px', detailPadding: 'px',
                    detailLineHeight: 'x'
                };
               
                Object.entries(sliders).forEach(([id, unit]) => {
                    const slider = document.getElementById(id);
                    const display = document.getElementById(`${id}Value`);
                    if (slider && display) {
                        const value = slider.value;
                        display.textContent = unit === 'x' ? `${value}x` : `${value}${unit}`;
                    }
                });
            }
            
            function resetSettings() {
                Object.entries(DEFAULT_SETTINGS).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) element.value = value;
                });
                updateSliderValues();
                updatePreview();
                elements.statusText.innerHTML = '🔄 <strong>Settings Reset</strong> - Optimized for storytelling';
            }
            
            // Event Listeners
            csvToggle.addEventListener('click', toggleCsv);
            elements.buttons.clearCsv.addEventListener('click', clearCsv);
            elements.buttons.loadTemplate.addEventListener('click', () => loadStoryTemplate('motivational'));
            
            tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
            
            elements.buttons.generateAll.addEventListener('click', generateAll);
            elements.buttons.previewAll.addEventListener('click', previewAll);
            elements.buttons.exportZip.addEventListener('click', () => exportStoryZip(Array.from(elements.results.children)));
            elements.buttons.exportVideo.addEventListener('click', exportVideoStory);
            elements.buttons.clearResults.addEventListener('click', () => {
                elements.results.innerHTML = '';
                elements.resultsPanel.style.display = 'none';
                elements.resultsCount.textContent = '(0 scenes)';
                imageCache.clear();
                elements.statusText.innerHTML = '🗑️ <strong>Results Cleared</strong>';
            });
            
            // Input Events
            elements.inputs.forEach(input => {
                input.addEventListener('input', () => {
                    updateSliderValues();
                    if (input.id === 'csvInput') {
                        parseStoryData();
                    } else {
                        updatePreview();
                    }
                });
                if (input.type === 'color') {
                    input.addEventListener('change', updatePreview);
                }
            });
            
            // CSV Input Change Detection
            elements.csvInput.addEventListener('input', debounce(parseStoryData, 500));
            
            // Drag & Drop
            elements.csvDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.csvDropZone.classList.add('dragover');
            });
            
            elements.csvDropZone.addEventListener('dragleave', () => {
                elements.csvDropZone.classList.remove('dragover');
            });
            
            elements.csvDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.csvDropZone.classList.remove('dragover');
               
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/csv' || file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            elements.csvInput.value = event.target.result;
                            parseStoryData();
                            elements.statusText.innerHTML = `
                                ✅ <strong>Story Dropped:</strong> ${file.name}
                                <span style="color: #10b981;">(${currentStoryData.length} scenes loaded)</span>
                            `;
                        };
                        reader.readAsText(file);
                    } else {
                        elements.statusText.innerHTML = '❌ <strong>Invalid File:</strong> Please drop CSV or text files only';
                    }
                }
            });
            
            // Theme Toggle
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                document.body.classList.toggle('light');
                const isDark = document.body.classList.contains('dark');
                themeToggle.textContent = isDark ? '☀️' : '🌙';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
            
            // Scroll to Top
            window.addEventListener('scroll', () => {
                goToTop.style.display = window.scrollY > 300 ? 'flex' : 'none';
            });
            
            goToTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'Enter':
                            e.preventDefault();
                            generateAll();
                            break;
                        case 'p':
                            e.preventDefault();
                            previewAll();
                            break;
                        case 's':
                            e.preventDefault();
                            exportStoryZip(Array.from(elements.results.children));
                            break;
                    }
                }
            });
            
            // Initialize
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.remove('dark');
                document.body.classList.add('light');
                themeToggle.textContent = '🌙';
            }
            
            updateSliderValues();
            parseStoryData();
            
            setTimeout(() => {
                elements.statusText.innerHTML = `
                    🎬 <strong>Welcome to Video Story Studio!</strong>
                    <br><small>Load a <strong>template</strong> or paste your story content to begin ✨</small>
                `;
            }, 1500);
        });
    </script>
</body>
</html>
