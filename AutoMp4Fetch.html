<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL to MP4 CSV with Preview</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            margin: 5px 0;
            cursor: pointer;
        }
        #preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .preview-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 100px;
        }
        .preview-item video {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .preview-item .error {
            width: 100px;
            height: 100px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .preview-item button {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .preview-item button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

<h2>Get .mp4 URLs from a Webpage</h2>

<label for="urlInput">Step 1: Enter Page URL:</label>
<input type="text" id="urlInput" placeholder="https://example.com">

<button id="fetchSourceBtn">Fetch HTML Source</button>

<label for="sourceCode">Step 2: HTML Source:</label>
<textarea id="sourceCode" rows="10" placeholder="HTML source will appear here..."></textarea>

<button id="extractBtn">Extract MP4s to CSV</button>
<button id="copyBtn">Copy CSV</button>

<h3>Output CSV</h3>
<textarea id="output" rows="10" readonly placeholder=".mp4 URLs will appear here..."></textarea>

<h3>Video Previews</h3>
<div id="preview-container"></div>

<script>
const urlInput = document.getElementById('urlInput');
const sourceCode = document.getElementById('sourceCode');
const output = document.getElementById('output');
const previewContainer = document.getElementById('preview-container');

// Convert relative URLs to absolute URLs
function toAbsoluteUrl(baseUrl, relativeUrl) {
    try {
        return new URL(relativeUrl, baseUrl).href;
    } catch {
        return relativeUrl;
    }
}

// Step 1: Fetch HTML source
document.getElementById('fetchSourceBtn').addEventListener('click', async () => {
    const url = urlInput.value.trim();
    if (!url) {
        alert('Enter a valid URL!');
        return;
    }

    output.value = '';
    sourceCode.value = 'Fetching...';
    previewContainer.innerHTML = '';

    try {
        const proxy = 'https://api.allorigins.win/get?url=';
        const response = await fetch(proxy + encodeURIComponent(url));
        const data = await response.json();
        sourceCode.value = data.contents;
    } catch (err) {
        sourceCode.value = '';
        alert('Error fetching URL! Check console.');
        console.error(err);
    }
});

// Step 2: Extract .mp4 URLs and show previews
document.getElementById('extractBtn').addEventListener('click', async () => {
    const html = sourceCode.value;
    if (!html.trim()) {
        alert('No HTML source to parse!');
        return;
    }

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // Collect all <video> and <source> tags
    const videoTags = doc.querySelectorAll('video, source');
    const baseUrl = urlInput.value.trim();
    const urls = Array.from(videoTags)
        .map(tag => tag.getAttribute('src'))
        .filter(src => src && src.trim().toLowerCase().endsWith('.mp4'))
        .map(src => toAbsoluteUrl(baseUrl, src));

    if (urls.length === 0) {
        output.value = 'No .mp4 videos found!';
        previewContainer.innerHTML = '<p>No .mp4 videos found!</p>';
        return;
    }

    output.value = urls.join('\n');

    // Clear previous previews
    previewContainer.innerHTML = '';

    // Create previews and open buttons
    for (const url of urls) {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';

        const video = document.createElement('video');
        video.src = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
        video.controls = true;
        video.muted = true;
        video.loop = true;
        video.style.maxWidth = '100px';
        video.style.maxHeight = '100px';
        video.onerror = () => {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = 'Video not loaded';
            previewItem.replaceChild(errorDiv, video);
        };
        previewItem.appendChild(video);

        const openBtn = document.createElement('button');
        openBtn.textContent = 'Open';
        openBtn.onclick = () => {
            window.open(url, '_blank');
        };
        previewItem.appendChild(openBtn);

        previewContainer.appendChild(previewItem);

        // Start video playback for preview
        video.play().catch(err => {
            console.error('Error playing video preview:', err);
        });
    }
});

// Copy CSV
document.getElementById('copyBtn').addEventListener('click', () => {
    output.select();
    document.execCommand('copy');
    alert('CSV copied to clipboard!');
});
</script>

</body>
</html>
