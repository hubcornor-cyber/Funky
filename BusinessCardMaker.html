<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Card Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #f3f4f6;
      font-family: 'Inter', 'Roboto', sans-serif;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(to right, #1e3a8a, #3b82f6);
      color: white;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 30;
      transition: transform 0.3s ease;
    }

    .header.hidden {
      transform: translateY(-100%);
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 80px; /* Space for header */
    }

    .card-mockup {
      width: 350px;
      height: 200px;
      background-color: #fff;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      position: fixed;
      top: 80px; /* Below header */
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }

    .card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .text-element, .logo, .qr-element {
      position: absolute;
      z-index: 2;
      cursor: move;
      user-select: none;
    }

    .text-element {
      min-width: 50px;
      padding: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      font-size: 14px;
    }

    .logo, .qr-element {
      max-width: 50px;
      max-height: 50px;
    }

    .resize-handle {
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 8px;
      height: 8px;
      background-color: #3b82f6;
      border-radius: 50%;
      cursor: se-resize;
      z-index: 3;
    }

    .selected {
      border: 2px solid #3b82f6;
      border-radius: 4px;
    }

    .controls-container {
      margin-top: 300px; /* Space for header + card */
      width: 100%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      background: linear-gradient(to bottom, #ffffff, #f9fafb);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 640px) {
      .controls-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .container {
        flex-direction: row;
        justify-content: center;
        gap: 1.5rem;
      }
      .controls-container {
        margin-top: 0;
        margin-left: 380px; /* Card width + gap */
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .control-section {
      border: 1px solid #e5e7eb;
      padding: 1rem;
      border-radius: 6px;
      background-color: #fff;
    }

    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 19px,
        rgba(0, 0, 0, 0.1) 20px
      ),
      repeating-linear-gradient(
        90deg,
        transparent,
        transparent 19px,
        rgba(0, 0, 0, 0.1) 20px
      );
      z-index: 0;
      pointer-events: none;
      opacity: 0.6;
    }

    .print-guides {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 3;
      pointer-events: none;
    }

    .trim-line {
      border: 2px solid #ef4444;
      width: 100%;
      height: 100%;
      border-radius: 8px;
    }

    .safe-area {
      position: absolute;
      top: 8px;
      left: 8px;
      width: calc(100% - 16px);
      height: calc(100% - 16px);
      border: 2px dashed #22c55e;
      border-radius: 4px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 20;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
    }

    .image-grid img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .image-grid img:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <header class="header" id="header">
    <h1 class="text-2xl font-semibold">Business Card Editor</h1>
  </header>
  <div class="container">
    <div class="card-mockup" id="cardMockup">
      <div class="grid-overlay" id="gridOverlay" style="display: none;"></div>
      <div class="print-guides" id="printGuides" style="display: none;">
        <div class="trim-line"></div>
        <div class="safe-area"></div>
      </div>
      <img src="https://static.vecteezy.com/system/resources/previews/024/140/681/non_2x/abstract-background-illustration-green-background-illustration-abstract-green-background-for-wallpaper-display-landing-page-banner-or-layout-simple-design-graphic-for-display-free-vector.jpg" alt="Business Card Mockup" class="card-image" id="cardImage">
    </div>
    <div class="controls-container">
      <div class="control-section">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Background</h3>
        <input type="file" id="backgroundInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-600 hover:file:bg-blue-100">
        <button id="onlineBackgroundBtn" class="mt-2 w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Choose Template</button>
      </div>
      <div class="control-section">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Add Elements</h3>
        <input type="file" id="logoInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-600 hover:file:bg-blue-100">
        <button id="addTextBtn" class="mt-2 w-full py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Add Text</button>
        <input type="text" id="qrUrlInput" placeholder="Enter URL for QR Code" class="mt-2 block w-full py-2 px-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="addQrBtn" class="mt-2 w-full py-2 px-4 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">Generate QR</button>
      </div>
      <div class="control-section">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Style Text</h3>
        <div id="styleControls">
          <label class="block text-sm font-medium text-gray-600">Text Color</label>
          <input type="color" id="textColor" value="#ffffff" class="mt-1 w-full h-8 rounded-md border border-gray-300">
          <label class="block text-sm font-medium text-gray-600 mt-2">Font</label>
          <select id="fontSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="Arial, sans-serif">Arial</option>
            <option value="'Roboto', sans-serif">Roboto</option>
            <option value="'Times New Roman', Times, serif">Times New Roman</option>
            <option value="'Georgia', serif">Georgia</option>
          </select>
          <label class="block text-sm font-medium text-gray-600 mt-2">Font Size</label>
          <input type="range" id="fontSize" min="8" max="48" value="14" class="mt-1 w-full">
          <span id="fontSizeValue" class="text-sm text-gray-500">14px</span>
          <div class="mt-2 flex gap-2">
            <button id="boldBtn" class="py-1 px-3 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Bold</button>
            <button id="italicBtn" class="py-1 px-3 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Italic</button>
            <button id="underlineBtn" class="py-1 px-3 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Underline</button>
          </div>
          <label class="block text-sm font-medium text-gray-600 mt-2">Alignment</label>
          <select id="alignmentSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="left">Left</option>
            <option value="center">Center</option>
            <option value="right">Right</option>
          </select>
          <div class="mt-3 flex gap-2">
            <button id="duplicateBtn" class="py-2 px-4 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors">Duplicate</button>
            <button id="deleteBtn" class="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Delete</button>
          </div>
        </div>
      </div>
      <div class="control-section">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Guides</h3>
        <label class="flex items-center">
          <input type="checkbox" id="gridToggle" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          <span class="text-sm text-gray-600">Show Grid</span>
        </label>
        <label class="flex items-center mt-2">
          <input type="checkbox" id="printGuidesToggle" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          <span class="text-sm text-gray-600">Show Print Guides</span>
        </label>
      </div>
      <div class="control-section col-span-full">
        <button id="resetCanvasBtn" class="w-full py-2 px-4 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Reset Canvas</button>
        <button id="downloadBtn" class="mt-2 w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Download PNG</button>
      </div>
    </div>
  </div>

  <div class="modal" id="backgroundModal">
    <div class="modal-content">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Select Template Background</h2>
      <div class="image-grid" id="imageGrid"></div>
      <button id="closeModal" class="mt-4 w-full py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Close</button>
    </div>
  </div>

  <script>
    const backgroundImages = [
      'https://png.pngtree.com/thumb_back/fh260/back_pic/04/16/74/5158259f411ac49.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-minimalistic-geometric-business-card-background-image_239792.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-business-atmosphere-business-card-background-image_243064.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-simple-business-card-background-image_240069.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-gradient-geometric-flat-business-card-background-image_243088.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_pic/04/32/44/085843de72ccfdd.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-simple-orange-business-card-background-image_240061.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-gradient-geometric-business-card-background-image_239805.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20190221/ourmid/pngtree-black-simple-business-invitation-card-image_40003.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-geometric-business-card-background-image_239795.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-geometric-business-minimalistic-business-card-background-image_237858.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_pic/04/30/10/6958403c968b168.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-orange-geometric-business-card-background-image_239807.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20220814/pngtree-credit-card-closeup-secure-business-card-photo-image_33200936.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_pic/04/32/01/325843684478042.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-geometric-flat-business-card-background-image_243066.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20201014/pngtree-abstract-wave-blue-particle-technology-background-abstract-design-template-for-brochures-image_416109.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_pic/04/60/02/68586bb9304f478.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-red-geometric-business-card-background-image_239811.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-black-business-atmosphere-business-card-background-image_243092.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20240509/pngtree-blue-gradient-abstract-business-card-background-vector-image_15728489.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_pic/03/87/91/6957d3a7094fbc7.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20250928/pngtree-black-business-cards-featuring-leveld-logo-placed-on-dark-surface-next-image_19641811.webp',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190621/ourmid/pngtree-metal-texture-business-simple-creative-business-card-image_177652.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-business-tech-business-card-background-image_243063.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-orange-geometric-business-card-background-image_243080.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20210417/pngtree-business-card-background-image_610075.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-red-geometric-business-card-background-image_243062.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-business-tech-business-card-background-image_239798.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-red-black-business-atmosphere-business-card-background-image_239810.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-black-business-atmosphere-business-card-background-image_239814.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20220218/pngtree-black-and-red-metal-superhero-business-card-background-image_957823.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-black-business-atmosphere-business-card-background-image_239793.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20210817/pngtree-geometric-business-card-red-business-background-image_762944.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20220825/pngtree-a-womans-hand-grasping-a-bunch-of-sleek-black-business-cards-with-no-writing-photo-image_33447890.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20250925/pngtree-stacks-of-business-cards-featuring-a-stylized-logo-set-against-vibrant-image_19621885.webp',
      'https://png.pngtree.com/thumb_back/fh260/background/20250925/pngtree-organized-modern-workspace-flat-lay-with-notebook-pen-wallet-and-business-image_19622394.webp',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190621/ourmid/pngtree-geometric-business-minimalistic-creative-business-card-image_177647.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20220215/pngtree-metal-wire-drawing-texture-business-simple-gray-business-card-background-image_926058.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-business-atmosphere-business-card-background-image_239808.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-geometric-business-tech-business-card-background-image_239809.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20220922/pngtree-multilingual-corporate-business-cards-for-festive-christmas-greetings-in-europe-photo-image_33883244.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20220218/pngtree-gold-brushed-business-card-background-image_966280.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-geometric-flat-business-card-background-image_243081.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20230207/pngtree-abstract-blue-gradient-geometric-business-card-background-image_1541501.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-black-business-atmosphere-business-card-background-image_243086.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190617/ourmid/pngtree-black-atmospheric-texture-business-card-background-material-image_128513.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-red-business-atmosphere-business-card-background-image_243061.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20220623/pngtree-flyer-business-card-background-template-image_1415171.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20220922/pngtree-european-language-merry-christmas-greetings-for-corporate-business-card-photo-image_33883014.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-line-business-atmosphere-business-card-background-image_239812.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190622/ourmid/pngtree-geometric-puzzle-color-business-card-background-image_218472.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-black-halo-business-technology-business-card-background-image_239821.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190628/ourmid/pngtree-flower-shop-business-card-image_264152.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20190221/ourmid/pngtree-business-invitation-card-synthesis-simple-image_16652.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-black-business-atmosphere-business-card-background-image_239797.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-black-geometric-business-card-background-image_239817.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190622/ourmid/pngtree-texture-geometric-business-card-frosted-background-image_217199.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190621/ourmid/pngtree-business-minimalist-creative-business-card-image_177667.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-blue-geometric-business-card-background-image_239791.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-black-business-atmosphere-business-card-background-image_243069.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-red-geometric-lines-business-card-background-image_239790.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190621/ourmid/pngtree-blue-business-minimalistic-creative-business-card-image_177654.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190623/ourmid/pngtree-business-geometric-contrast-color-business-card-background-image_237854.jpg',
      'https://png.pngtree.com/thumb_back/fh260/background/20200718/pngtree-islamic-new-year-greeting-card-business-background-image_358319.jpg',
      'https://png.pngtree.com/thumb_back/fh260/back_our/20190621/ourmid/pngtree-blue-technology-fashion-business-card-image_177277.jpg'
    ];

    const cardMockup = document.getElementById('cardMockup');
    const cardImage = document.getElementById('cardImage');
    const backgroundInput = document.getElementById('backgroundInput');
    const logoInput = document.getElementById('logoInput');
    const addTextBtn = document.getElementById('addTextBtn');
    const qrUrlInput = document.getElementById('qrUrlInput');
    const addQrBtn = document.getElementById('addQrBtn');
    const textColor = document.getElementById('textColor');
    const fontSelect = document.getElementById('fontSelect');
    const fontSize = document.getElementById('fontSize');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const boldBtn = document.getElementById('boldBtn');
    const italicBtn = document.getElementById('italicBtn');
    const underlineBtn = document.getElementById('underlineBtn');
    const alignmentSelect = document.getElementById('alignmentSelect');
    const duplicateBtn = document.getElementById('duplicateBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const gridToggle = document.getElementById('gridToggle');
    const gridOverlay = document.getElementById('gridOverlay');
    const printGuidesToggle = document.getElementById('printGuidesToggle');
    const printGuides = document.getElementById('printGuides');
    const resetCanvasBtn = document.getElementById('resetCanvasBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const onlineBackgroundBtn = document.getElementById('onlineBackgroundBtn');
    const backgroundModal = document.getElementById('backgroundModal');
    const imageGrid = document.getElementById('imageGrid');
    const closeModal = document.getElementById('closeModal');
    const header = document.getElementById('header');

    let currentSelected = null;
    let elementId = 0;

    // Hide header on scroll
    let lastScrollY = 0;
    window.addEventListener('scroll', () => {
      const currentScrollY = window.scrollY;
      if (currentScrollY > lastScrollY && currentScrollY > 50) {
        header.classList.add('hidden');
      } else {
        header.classList.remove('hidden');
      }
      lastScrollY = currentScrollY;
    });

    // Populate image grid
    function populateImageGrid() {
      imageGrid.innerHTML = '';
      backgroundImages.forEach((url, index) => {
        const img = document.createElement('img');
        img.src = url;
        img.alt = `Background ${index + 1}`;
        img.addEventListener('click', () => {
          cardImage.src = url;
          backgroundModal.style.display = 'none';
        });
        imageGrid.appendChild(img);
      });
    }

    onlineBackgroundBtn.addEventListener('click', () => {
      populateImageGrid();
      backgroundModal.style.display = 'flex';
    });

    closeModal.addEventListener('click', () => {
      backgroundModal.style.display = 'none';
    });

    backgroundModal.addEventListener('click', (e) => {
      if (e.target === backgroundModal) {
        backgroundModal.style.display = 'none';
      }
    });

    // Drag functionality
    function makeDraggable(element) {
      let isDragging = false;
      let currentX, currentY, initialX, initialY;

      element.addEventListener('mousedown', startDragging);
      element.addEventListener('touchstart', startDragging, { passive: false });

      function startDragging(e) {
        e.preventDefault();
        isDragging = true;
        const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
        initialX = clientX - (parseFloat(element.style.left) || 0);
        initialY = clientY - (parseFloat(element.style.top) || 0);
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', stopDragging);
        document.addEventListener('touchend', stopDragging);
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
        const rect = cardMockup.getBoundingClientRect();
        let x = clientX - initialX;
        let y = clientY - initialY;

        if (gridToggle.checked) {
          x = Math.round(x / 20) * 20;
          y = Math.round(y / 20) * 20;
        }

        x = Math.max(0, Math.min(x, rect.width - element.offsetWidth));
        y = Math.max(0, Math.min(y, rect.height - element.offsetHeight));

        element.style.left = `${x}px`;
        element.style.top = `${y}px`;
        element.style.bottom = 'auto';
        element.style.right = 'auto';
      }

      function stopDragging() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', stopDragging);
        document.removeEventListener('touchend', stopDragging);
      }
    }

    // Resize functionality
    function makeResizable(element, handle, isImage = false) {
      let isResizing = false;
      let startWidth, startHeight, startX, startY;

      handle.addEventListener('mousedown', startResizing);
      handle.addEventListener('touchstart', startResizing, { passive: false });

      function startResizing(e) {
        e.preventDefault();
        isResizing = true;
        startWidth = element.offsetWidth;
        startHeight = element.offsetHeight;
        startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
        document.addEventListener('mousemove', resize);
        document.addEventListener('touchmove', resize, { passive: false });
        document.addEventListener('mouseup', stopResizing);
        document.addEventListener('touchend', stopResizing);
      }

      function resize(e) {
        if (!isResizing) return;
        e.preventDefault();
        const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
        const dx = clientX - startX;
        const dy = clientY - startY;
        if (isImage) {
          element.style.maxWidth = `${Math.max(20, startWidth + dx)}px`;
          element.style.maxHeight = `${Math.max(20, startHeight + dy)}px`;
        } else {
          element.style.width = `${Math.max(50, startWidth + dx)}px`;
          element.style.fontSize = `${Math.max(8, parseInt(element.style.fontSize) + dy / 10)}px`;
        }
      }

      function stopResizing() {
        isResizing = false;
        document.removeEventListener('mousemove', resize);
        document.removeEventListener('touchmove', resize);
        document.removeEventListener('mouseup', stopResizing);
        document.removeEventListener('touchend', stopResizing);
      }
    }

    // Pinch-to-resize
    function addPinchResize(element, isImage = false) {
      let initialDistance = 0;
      let startWidth = 0;

      element.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          initialDistance = Math.hypot(touch1.clientX - touch2.clientX, touch1.clientY - touch2.clientY);
          startWidth = element.offsetWidth;
        }
      });

      element.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const distance = Math.hypot(touch1.clientX - touch2.clientX, touch1.clientY - touch2.clientY);
          const scale = distance / initialDistance;
          if (isImage) {
            element.style.maxWidth = `${Math.max(20, startWidth * scale)}px`;
            element.style.maxHeight = `${Math.max(20, startWidth * scale)}px`;
          } else {
            element.style.width = `${Math.max(50, startWidth * scale)}px`;
          }
        }
      });
    }

    // Add selection and text editing
    function addSelection(element, handle = null) {
      element.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSelected) {
          currentSelected.classList.remove('selected');
          if (currentSelected.handle) currentSelected.handle.style.display = 'none';
        }
        currentSelected = element;
        currentSelected.classList.add('selected');
        currentSelected.handle = handle;
        if (handle) handle.style.display = 'block';
        loadStylesToControls();
      });

      // Enable text editing on double-click
      if (element.classList.contains('text-element')) {
        element.addEventListener('dblclick', () => {
          element.contentEditable = true;
          element.focus();
        });
        element.addEventListener('blur', () => {
          element.contentEditable = false;
          if (element.innerText.trim() === '') {
            element.innerText = 'New Text';
          }
        });
      }
    }

    // Load styles to controls
    function loadStylesToControls() {
      if (!currentSelected || !currentSelected.classList.contains('text-element')) return;
      textColor.value = rgbToHex(currentSelected.style.color) || '#ffffff';
      fontSelect.value = currentSelected.style.fontFamily || 'Arial, sans-serif';
      fontSize.value = parseInt(currentSelected.style.fontSize) || 14;
      fontSizeValue.textContent = `${fontSize.value}px`;
      alignmentSelect.value = currentSelected.style.textAlign || 'left';
      boldBtn.classList.toggle('bg-blue-300', currentSelected.style.fontWeight === 'bold');
      italicBtn.classList.toggle('bg-blue-300', currentSelected.style.fontStyle === 'italic');
      underlineBtn.classList.toggle('bg-blue-300', currentSelected.style.textDecoration === 'underline');
    }

    // RGB to Hex
    function rgbToHex(rgb) {
      if (!rgb || rgb === 'none') return '#ffffff';
      const match = rgb.match(/\d+/g);
      if (!match) return '#ffffff';
      const [r, g, b] = match;
      return '#' + ((1 << 24) + (parseInt(r) << 16) + (parseInt(g) << 8) + parseInt(b)).toString(16).slice(1);
    }

    // Apply styles
    function applyStyles() {
      if (!currentSelected || !currentSelected.classList.contains('text-element')) return;
      currentSelected.style.color = textColor.value;
      currentSelected.style.fontFamily = fontSelect.value;
      currentSelected.style.fontSize = `${fontSize.value}px`;
      currentSelected.style.textAlign = alignmentSelect.value;
      currentSelected.style.fontWeight = boldBtn.classList.contains('bg-blue-300') ? 'bold' : 'normal';
      currentSelected.style.fontStyle = italicBtn.classList.contains('bg-blue-300') ? 'italic' : 'normal';
      currentSelected.style.textDecoration = underlineBtn.classList.contains('bg-blue-300') ? 'underline' : 'none';
    }

    // Create text element
    addTextBtn.addEventListener('click', () => {
      const textElement = document.createElement('div');
      textElement.className = 'text-element';
      textElement.id = `element-${elementId++}`;
      textElement.contentEditable = false;
      textElement.innerText = 'New Text';
      textElement.style.left = '50px';
      textElement.style.top = '50px';
      textElement.style.color = '#fff';
      textElement.style.fontSize = '14px';
      textElement.style.textAlign = 'left';
      textElement.style.zIndex = '2';
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'resize-handle';
      textElement.appendChild(resizeHandle);
      cardMockup.appendChild(textElement);
      makeDraggable(textElement);
      makeResizable(textElement, resizeHandle);
      addPinchResize(textElement);
      addSelection(textElement, resizeHandle);
    });

    // Add logo
    logoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          const logo = document.createElement('img');
          logo.className = 'logo';
          logo.id = `element-${elementId++}`;
          logo.src = reader.result;
          logo.style.left = '10px';
          logo.style.top = '10px';
          logo.style.zIndex = '2';
          logo.style.display = 'block';
          const resizeHandle = document.createElement('div');
          resizeHandle.className = 'resize-handle';
          cardMockup.appendChild(logo);
          cardMockup.appendChild(resizeHandle);
          resizeHandle.style.display = 'block';
          makeDraggable(logo);
          makeResizable(logo, resizeHandle, true);
          addPinchResize(logo, true);
          addSelection(logo, resizeHandle);
        };
        reader.readAsDataURL(file);
      }
    });

    // Add QR code
    addQrBtn.addEventListener('click', () => {
      const url = qrUrlInput.value;
      if (url) {
        const qrDiv = document.createElement('div');
        qrDiv.id = `element-${elementId++}`;
        qrDiv.className = 'qr-element';
        qrDiv.style.left = '10px';
        qrDiv.style.top = '10px';
        qrDiv.style.zIndex = '2';
        new QRCode(qrDiv, {
          text: url,
          width: 50,
          height: 50
        });
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        cardMockup.appendChild(qrDiv);
        cardMockup.appendChild(resizeHandle);
        resizeHandle.style.display = 'block';
        makeDraggable(qrDiv);
        makeResizable(qrDiv, resizeHandle, true);
        addPinchResize(qrDiv, true);
        addSelection(qrDiv, resizeHandle);
        qrUrlInput.value = '';
      }
    });

    // Background upload
    backgroundInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          cardImage.src = reader.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Style listeners
    textColor.addEventListener('input', applyStyles);
    fontSelect.addEventListener('change', applyStyles);
    fontSize.addEventListener('input', () => {
      fontSizeValue.textContent = `${fontSize.value}px`;
      applyStyles();
    });
    boldBtn.addEventListener('click', () => {
      boldBtn.classList.toggle('bg-blue-300');
      applyStyles();
    });
    italicBtn.addEventListener('click', () => {
      italicBtn.classList.toggle('bg-blue-300');
      applyStyles();
    });
    underlineBtn.addEventListener('click', () => {
      underlineBtn.classList.toggle('bg-blue-300');
      applyStyles();
    });
    alignmentSelect.addEventListener('change', applyStyles);

    // Duplicate selected
    duplicateBtn.addEventListener('click', () => {
      if (!currentSelected) return;
      const clone = currentSelected.cloneNode(true);
      clone.id = `element-${elementId++}`;
      clone.style.left = `${parseFloat(currentSelected.style.left) + 10}px`;
      clone.style.top = `${parseFloat(currentSelected.style.top) + 10}px`;
      const resizeHandle = clone.querySelector('.resize-handle') || document.createElement('div');
      if (!clone.querySelector('.resize-handle')) {
        resizeHandle.className = 'resize-handle';
        clone.appendChild(resizeHandle);
      }
      cardMockup.appendChild(clone);
      makeDraggable(clone);
      makeResizable(clone, resizeHandle, !clone.classList.contains('text-element'));
      addPinchResize(clone, !clone.classList.contains('text-element'));
      addSelection(clone, resizeHandle);
    });

    // Delete selected
    deleteBtn.addEventListener('click', () => {
      if (currentSelected) {
        currentSelected.remove();
        currentSelected = null;
      }
    });

    // Deselect
    cardMockup.addEventListener('click', (e) => {
      if (e.target === cardMockup && currentSelected) {
        currentSelected.classList.remove('selected');
        if (currentSelected.handle) currentSelected.handle.style.display = 'none';
        currentSelected = null;
      }
    });

    // Grid toggle
    gridToggle.addEventListener('change', () => {
      gridOverlay.style.display = gridToggle.checked ? 'block' : 'none';
    });

    // Print guides toggle
    printGuidesToggle.addEventListener('change', () => {
      printGuides.style.display = printGuidesToggle.checked ? 'block' : 'none';
    });

    // Reset canvas
    resetCanvasBtn.addEventListener('click', () => {
      cardImage.src = backgroundImages[0];
      document.querySelectorAll('.text-element, .logo, .qr-element, .resize-handle').forEach(el => el.remove());
      currentSelected = null;
      gridToggle.checked = false;
      gridOverlay.style.display = 'none';
      printGuidesToggle.checked = false;
      printGuides.style.display = 'none';
    });

    // Download PNG
    downloadBtn.addEventListener('click', () => {
      // Ensure background image is loaded
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.src = cardImage.src;
      img.onload = () => {
        document.querySelectorAll('.resize-handle').forEach(h => h.style.display = 'none');
        document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
        gridOverlay.style.display = 'none';
        printGuides.style.display = 'none';

        html2canvas(cardMockup, {
          scale: 3,
          useCORS: true,
          backgroundColor: null
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = 'business_card.png';
          link.href = canvas.toDataURL('image/png');
          link.click();

          document.querySelectorAll('.resize-handle').forEach(h => h.style.display = 'block');
          gridOverlay.style.display = gridToggle.checked ? 'block' : 'none';
          printGuides.style.display = printGuidesToggle.checked ? 'block' : 'none';
        });
      };
    });

    // Initial text overlay
    const initialText = document.createElement('div');
    initialText.className = 'text-element';
    initialText.id = `element-${elementId++}`;
    initialText.innerHTML = '<h3 contenteditable="true">John Doe</h3><p contenteditable="true">Graphic Designer | john.doe@example.com</p>';
    initialText.style.left = '10px';
    initialText.style.top = '10px';
    initialText.style.color = '#fff';
    initialText.style.fontSize = '14px';
    initialText.style.zIndex = '2';
    const initialResize = document.createElement('div');
    initialResize.className = 'resize-handle';
    initialText.appendChild(initialResize);
    cardMockup.appendChild(initialText);
    makeDraggable(initialText);
    makeResizable(initialText, initialResize);
    addPinchResize(initialText);
    addSelection(initialText, initialResize);
  </script>
</body>
</html>
