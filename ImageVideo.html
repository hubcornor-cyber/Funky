<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Image → Video Converter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
      padding: 20px;
    }

    .container {
      width: 80%;
      margin: 0 auto;
    }

    .card {
      background: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .btn.ghost {
      background-color: transparent;
      color: #007bff;
    }

    input[type="file"] {
      display: none;
    }

    input[type="number"] {
      width: 80px;
    }

    select {
      width: 100%;
    }

    #outVideo {
      display: none;
      margin-top: 20px;
      max-width: 100%;
    }

    .progress {
      background-color: #ddd;
      width: 100%;
      height: 10px;
      border-radius: 5px;
    }

    .bar {
      background-color: #007bff;
      width: 0;
      height: 100%;
      border-radius: 5px;
    }

    small {
      font-size: 12px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Image → Video Converter</h1>
      <div class="muted">Client-side • MP4/MKV</div>
    </header>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <label class="btn">+ Add Images
          <input id="fileInput" type="file" accept="image/*" multiple>
        </label>
        <label class="btn ghost">+ Add Audio
          <input id="audioInput" type="file" accept="audio/*">
        </label>
        <span id="srtFileName" class="small">No captions loaded</span>
      </div>
      <div style="margin-top:12px" class="row">
        <label class="small">FPS</label><input id="fps" class="number" type="number" min="1" max="60" value="30" style="width:72px">
        <label class="small">Resolution</label>
        <select id="size" class="select">
          <option value="1920x1080">YouTube (1920×1080)</option>
          <option value="1080x1920">TikTok (1080×1920)</option>
          <option value="1080x1080">Instagram (1080×1080)</option>
          <option value="1280x720">720p (1280×720)</option>
        </select>
      </div>
      <div style="margin-top:12px" class="row">
        <div>Total Video Length: <span id="totalDuration">0s</span></div>
      </div>
    </section>

    <section class="card">
      <div class="small">Images</div>
      <div id="list" class="list"></div>
      <div class="preview-row" style="margin-top:10px">
        <div style="flex:1">
          <div class="small">Effect Preview</div>
          <canvas id="effectPreviewCanvas" width="480" height="270"></canvas>
          <div style="margin-top:8px" class="row">
            <button id="playPreview" class="btn">▶ Play</button>
            <button id="stopPreview" class="btn ghost">■ Stop</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="gap:8px;align-items:center">
        <button id="generateBtn" class="btn">▶ Generate Video</button>
        <button id="cancelBtn" class="btn ghost" style="display:none">✖ Cancel</button>
      </div>
      <div style="margin-top:10px">
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px">
          <div class="small" id="progressPercent">0%</div>
          <div class="small" id="progressTime">0s / 0s</div>
        </div>
        <video id="outVideo" controls playsinline></video>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <a id="downloadLink" class="btn ghost" style="display:none">⬇ Download MP4</a>
        </div>
      </div>
    </section>

    <footer>Built with MediaRecorder + Canvas</footer>
  </div>

  <script>
    // JavaScript to handle image and audio input, preview, and video generation

    const state = {
      items: [],
      nextId: 1,
      audio: null,
      canvas: document.createElement('canvas'),
      ctx: null,
    };

    const fileInput = document.getElementById('fileInput');
    const audioInput = document.getElementById('audioInput');
    const fpsInput = document.getElementById('fps');
    const sizeSelect = document.getElementById('size');
    const totalDurationEl = document.getElementById('totalDuration');
    const playPreviewBtn = document.getElementById('playPreview');
    const stopPreviewBtn = document.getElementById('stopPreview');
    const previewCanvas = document.getElementById('effectPreviewCanvas');
    const pctx = previewCanvas.getContext('2d');
    const generateBtn = document.getElementById('generateBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const progressBar = document.getElementById('bar');
    const progressPercent = document.getElementById('progressPercent');
    const progressTime = document.getElementById('progressTime');
    const outVideo = document.getElementById('outVideo');
    const downloadLink = document.getElementById('downloadLink');

    state.ctx = state.canvas.getContext('2d');

    // Add images to the list
    fileInput.addEventListener('change', async e => {
      const files = Array.from(e.target.files || []);
      for (const f of files) {
        if (!f.type.startsWith('image/')) continue;
        const url = URL.createObjectURL(f);
        const img = new Image();
        await new Promise(r => { img.onload = r; img.src = url; });
        state.items.push({ id: state.nextId++, file: f, url, img, duration: 3 });
      }
      updateTotalDuration();
    });

    // Add audio
    audioInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      state.audio = new Audio(url);
      state.audio.loop = true; // Make the audio loop for testing
    });

    // Update total video duration based on images
    function updateTotalDuration() {
      let total = 0;
      state.items.forEach(it => total += parseFloat(it.duration || 3));
      totalDurationEl.textContent = Math.round(total) + 's';
    }

    // Render the preview of frames on the canvas
    function renderPreview() {
      let idx = 0;
      let startTime = Date.now();
      const fps = parseFloat(fpsInput.value) || 30;

      function previewFrame() {
        if (idx >= state.items.length) {
          cancelAnimationFrame(previewRAF);
          return;
        }

        const image = state.items[idx].img;
        const duration = state.items[idx].duration;
        const timeElapsed = (Date.now() - startTime) / 1000;

        // Draw the current frame on the canvas
        state.ctx.clearRect(0, 0, state.canvas.width, state.canvas.height);
        state.ctx.drawImage(image, 0, 0, state.canvas.width, state.canvas.height);

        // If the current frame has finished displaying, move to the next
        if (timeElapsed > (idx + 1) * duration) {
          idx++;
        }

        previewRAF = requestAnimationFrame(previewFrame);
      }

      previewFrame();
    }

    playPreviewBtn.addEventListener('click', () => {
      state.audio.play();
      renderPreview();
    });

    stopPreviewBtn.addEventListener('click', () => {
      state.audio.pause();
      cancelAnimationFrame(previewRAF);
    });

    // Video generation logic
    generateBtn.addEventListener('click', () => {
      const totalFrames = state.items.length;
      const fps = parseFloat(fpsInput.value);
      const duration = parseFloat(fpsInput.value);

      // MediaRecorder to record the canvas
      const stream = previewCanvas.captureStream(fps);
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = event => {
        recordedChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/mp4' });
        const videoURL = URL.createObjectURL(blob);
        outVideo.src = videoURL;
        outVideo.style.display = 'block';

        downloadLink.href = videoURL;
        downloadLink.download = 'output.mp4';
        downloadLink.style.display = 'inline-block';
      };

      mediaRecorder.start();

      // Simulate rendering and audio sync
      setTimeout(() => {
        mediaRecorder.stop();
      }, totalFrames * duration * 1000);
    });

    cancelBtn.addEventListener('click', () => {
      mediaRecorder.stop();
      outVideo.style.display = 'none';
      downloadLink.style.display = 'none';
    });
  </script>
</body>
</html>
