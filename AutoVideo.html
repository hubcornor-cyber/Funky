<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Create Video from Images with Captions</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      color: #f1f5f9;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: #f1f5f9;
    }
    body.light {
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      color: #2c3e50;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .top-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      gap: 20px;
    }
    .preview-panel, .control-panel {
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .4);
      flex: 1;
      min-width: 300px;
      max-width: 600px;
      height: auto;
    }
    body.light .preview-panel, body.light .control-panel, body.light .results-panel {
      background: rgba(255, 255, 255, 0.85);
      color: #2c3e50;
    }
    body.light h2 { color: #007bff; }
    body.light label { color: #34495e; }
    body.light input, body.light textarea, body.light select {
      background: #ecf0f1;
      color: #2c3e50;
    }
    body.light .slider-value, body.light .status-text { color: #7f8c8d; }
    body.light .progress-container { background: #bdc3c7; }
    body.light .btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
    }
    body.light .btn:disabled { background: #95a5a6; }
    body.light .result-item { background: rgba(255, 255, 255, .9); }
    .results-panel {
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      margin: 20px 0;
      padding: 16px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .4);
      width: 90%;
      max-width: 1200px;
    }
    h2 { margin: 0 0 8px; font-size: 16px; color: #93c5fd; }
    label {
      display: block;
      margin-top: 6px;
      font-weight: 600;
      font-size: 11px;
      color: #e2e8f0;
    }
    input, textarea, select {
      width: 100%;
      padding: 5px;
      margin-top: 3px;
      border: none;
      border-radius: 6px;
      background: #1e293b;
      color: #f8fafc;
      resize: none;
      font-size: 11px;
    }
    input[type="color"] { padding: 1px; height: 28px; cursor: pointer; }
    input[type="range"] { cursor: pointer; }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .slider-value { font-size: 10px; color: #cbd5e1; }
    .btn {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
      transition: transform .2s, box-shadow .2s;
    }
    .btn:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }
    .btn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(37, 99, 235, .6);
    }
    .progress-container {
      margin-top: 8px;
      height: 14px;
      background: #334155;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #60a5fa, #3b82f6);
      transition: width .3s;
    }
    .status-text {
      margin-top: 3px;
      font-size: 11px;
      color: #cbd5e1;
    }
    .results {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }
    .result-item {
      background: rgba(30, 41, 59, .9);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .4);
      transition: transform .2s;
    }
    .result-item:hover {
      transform: translateY(-4px);
    }
    .result-item video {
      max-width: 100%;
      border-radius: 8px;
    }
    .preview {
      text-align: center;
    }
    .preview canvas {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .6);
    }
    #themeToggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    #goToTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px 15px;
      border-radius: 50%;
      font-size: 14px;
      display: none;
    }
    .control-columns {
      display: flex;
      gap: 20px;
      margin-top: 6px;
    }
    .color-column, .align-column {
      flex: 1;
    }
    @media (max-width: 768px) {
      .top-row {
        flex-direction: column;
      }
      .preview-panel, .control-panel, .results-panel {
        width: 95%;
      }
      .control-columns {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body class="dark">
  <button class="btn" id="themeToggle">Switch to Light</button>
  <button class="btn" id="goToTop">â†‘ Top</button>
  <div class="container" id="layout">
    <div class="top-row">
      <div class="preview-panel">
        <h2>Preview</h2>
        <div class="preview"><canvas id="previewCanvas"></canvas></div>
      </div>

      <div class="control-panel" id="controls">
        <h2>Controls</h2>
        <label>CSV Input (image_url,title,detail_text)</label>
        <textarea id="csvInput" rows="4">https://picsum.photos/600,Sample Title,This is detail text
https://picsum.photos/620,Another Title,Second image description
https://picsum.photos/640,Third Title,Third image details</textarea>
        
        <label>Title Size</label>
        <div class="slider-container">
          <input type="range" id="titleSize" min="10" max="100" value="36">
          <span class="slider-value" id="titleSizeValue">36</span>
        </div>
        <label>Detail Size</label>
        <div class="slider-container">
          <input type="range" id="detailSize" min="10" max="80" value="24">
          <span class="slider-value" id="detailSizeValue">24</span>
        </div>
        <div class="control-columns">
          <div class="color-column">
            <label>Text Color</label><input type="color" id="textColor" value="#ffffff">
            <label>Detail Background Color 1</label><input type="color" id="detailBg1" value="#00000000">
            <label>Detail Background Color 2</label><input type="color" id="detailBg2" value="#000000">
            <label>Detail Background Opacity</label>
            <div class="slider-container">
              <input type="range" id="detailBgOpacity" min="0" max="100" value="80">
              <span class="slider-value" id="detailBgOpacityValue">80</span>
            </div>
            <label>Title Border Color</label><input type="color" id="titleBorderColor" value="#ffffff">
            <label>Title Glow Color</label><input type="color" id="titleGlowColor" value="#ff0000">
          </div>
          <div class="align-column">
            <label>Adjust Title Position</label>
            <div class="slider-container">
              <input type="range" id="titleSlider" min="0" max="200" value="0">
              <span class="slider-value" id="titleSliderValue">0</span>
            </div>
            <label>Adjust Detail Position</label>
            <div class="slider-container">
              <input type="range" id="detailSlider" min="0" max="200" value="0">
              <span class="slider-value" id="detailSliderValue">0</span>
            </div>
            <label>Title Alignment</label>
            <select id="titleAlign">
              <option value="center">Center</option>
              <option value="left">Left</option>
              <option value="right">Right</option>
            </select>
            <label>Detail Alignment</label>
            <select id="detailAlign">
              <option value="center">Center</option>
              <option value="left">Left</option>
              <option value="right">Right</option>
            </select>
            <label>Font Family</label>
            <select id="fontFamily">
              <option value="Segoe UI">Segoe UI</option>
              <option value="Arial">Arial</option>
              <option value="Roboto">Roboto</option>
              <option value="Open Sans">Open Sans</option>
            </select>
            <label>Duration per Image (seconds)</label>
            <div class="slider-container">
              <input type="range" id="duration" min="1" max="10" value="3">
              <span class="slider-value" id="durationValue">3</span>
            </div>
          </div>
        </div>

        <button class="btn" id="loadImagesBtn">Load Images</button>
        <button class="btn" id="generateVideoBtn" disabled>Generate Video</button>
        <button class="btn" id="resetBtn">Reset Settings</button>

        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="status-text" id="statusText">Idle</div>
      </div>
    </div>

    <div class="results-panel">
      <h2>Results</h2>
      <div id="results" class="results"></div>
    </div>
  </div>

  <script>
    // Constants
    const DEFAULT_SETTINGS = {
      titleSize: 36,
      detailSize: 24,
      textColor: '#ffffff',
      detailBg1: '#00000000',
      detailBg2: '#000000',
      detailBgOpacity: 80,
      titleBorderColor: '#ffffff',
      titleGlowColor: '#ff0000',
      titleSlider: 0,
      detailSlider: 0,
      titleAlign: 'center',
      detailAlign: 'center',
      fontFamily: 'Segoe UI',
      duration: 3
    };
    const MAX_WIDTH = 600;
    const DEBOUNCE_DELAY = 300;
    const FPS = 30;
    const VIDEO_WIDTH = 600;
    const VIDEO_HEIGHT = 400;

    // DOM Elements
    const elements = {
      layout: document.getElementById('layout'),
      previewCanvas: document.getElementById('previewCanvas'),
      results: document.getElementById('results'),
      progressBar: document.getElementById('progressBar'),
      statusText: document.getElementById('statusText'),
      csvInput: document.getElementById('csvInput'),
      inputs: ['titleSize', 'detailSize', 'textColor', 'detailBg1', 'detailBg2', 'detailBgOpacity', 'titleBorderColor', 'titleGlowColor', 'titleSlider', 'detailSlider', 'titleAlign', 'detailAlign', 'fontFamily', 'duration', 'csvInput'].map(id => document.getElementById(id)),
      buttons: {
        loadImages: document.getElementById('loadImagesBtn'),
        generateVideo: document.getElementById('generateVideoBtn'),
        reset: document.getElementById('resetBtn')
      }
    };
    const ctx = elements.previewCanvas.getContext('2d');
    const themeToggle = document.getElementById('themeToggle');
    const goToTop = document.getElementById('goToTop');

    // Image Cache
    const imageCache = new Map();
    let imagesLoaded = false;

    // Utility Functions
    const debounce = (func, delay) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
      };
    };

    const validateCsvLine = (line) => {
      const parts = line.split(',');
      return parts.length === 3 && parts.every(part => part.trim());
    };

    const loadImage = async (src) => {
      if (imageCache.has(src)) return imageCache.get(src);
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          imageCache.set(src, img);
          resolve(img);
        };
        img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
        img.src = src;
      });
    };

    const drawRoundedRect = (ctx, x, y, w, h, r) => {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    };

    const getSettings = () => ({
      titleSize: +document.getElementById('titleSize').value,
      detailSize: +document.getElementById('detailSize').value,
      textColor: document.getElementById('textColor').value,
      detailBg1: document.getElementById('detailBg1').value,
      detailBg2: document.getElementById('detailBg2').value,
      detailBgOpacity: +document.getElementById('detailBgOpacity').value,
      titleBorderColor: document.getElementById('titleBorderColor').value,
      titleGlowColor: document.getElementById('titleGlowColor').value,
      titleSlider: +document.getElementById('titleSlider').value,
      detailSlider: +document.getElementById('detailSlider').value,
      titleAlign: document.getElementById('titleAlign').value,
      detailAlign: document.getElementById('detailAlign').value,
      fontFamily: document.getElementById('fontFamily').value,
      duration: +document.getElementById('duration').value
    });

    const drawOverlay = (ctx, img, title, detail, settings, width, height) => {
      ctx.clearRect(0, 0, width, height);
      const aspectImg = img.width / img.height;
      const aspectVideo = width / height;
      let drawW, drawH, drawX, drawY;
      if (aspectImg > aspectVideo) {
        drawW = width;
        drawH = width / aspectImg;
        drawX = 0;
        drawY = (height - drawH) / 2;
      } else {
        drawH = height;
        drawW = height * aspectImg;
        drawY = 0;
        drawX = (width - drawW) / 2;
      }
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, width, height);
      ctx.drawImage(img, drawX, drawY, drawW, drawH);

      ctx.font = `${settings.titleSize}px ${settings.fontFamily}`;
      ctx.textAlign = settings.titleAlign;
      ctx.textBaseline = 'top';
      ctx.strokeStyle = settings.titleBorderColor;
      ctx.lineWidth = 2;
      ctx.shadowColor = settings.titleGlowColor;
      ctx.shadowBlur = 15;
      const titleX = settings.titleAlign === 'left' ? 20 : settings.titleAlign === 'right' ? width - 20 : width / 2;
      const titleOffset = settings.titleSlider;
      ctx.strokeText(title, titleX, 20 + titleOffset);
      ctx.shadowBlur = 0;
      ctx.fillStyle = settings.textColor;
      ctx.fillText(title, titleX, 20 + titleOffset);

      const lines = detail.split('\n');
      const lineHeight = settings.detailSize + 6;
      lines.forEach((line, i) => {
        ctx.font = `${settings.detailSize}px ${settings.fontFamily}`;
        ctx.textAlign = settings.detailAlign;
        const textWidth = ctx.measureText(line).width;
        const padding = 8;
        const lineY = height - (lines.length - i) * lineHeight - 20 - settings.detailSlider;
        const detailX = settings.detailAlign === 'left' ? 20 : settings.detailAlign === 'right' ? width - 20 : width / 2;
        const gradient = ctx.createLinearGradient(0, lineY, 0, lineY + settings.detailSize + padding * 2);
        gradient.addColorStop(0, settings.detailBg1);
        gradient.addColorStop(1, settings.detailBg2);
        ctx.fillStyle = gradient;
        ctx.globalAlpha = settings.detailBgOpacity / 100;
        drawRoundedRect(ctx, detailX - textWidth / 2 - padding, lineY - padding, textWidth + padding * 2, settings.detailSize + padding * 2, 10);
        ctx.fill();
        ctx.globalAlpha = 1;
        ctx.fillStyle = settings.textColor;
        ctx.fillText(line, detailX, lineY);
      });
    };

    const updateSliderValues = () => {
      ['titleSize', 'detailSize', 'detailBgOpacity', 'titleSlider', 'detailSlider', 'duration'].forEach(id => {
        const value = document.getElementById(id).value;
        document.getElementById(`${id}Value`).textContent = value;
      });
    };

    const updatePreview = debounce(async () => {
      const csvLines = elements.csvInput.value.trim().split('\n').filter(l => l && validateCsvLine(l));
      if (!csvLines.length) {
        elements.statusText.textContent = 'No valid CSV input provided.';
        return;
      }
      const [src, title, detail] = csvLines[0].split(',');
      try {
        const img = await loadImage(src.trim());
        const settings = getSettings();
        const scale = Math.min(MAX_WIDTH / img.width, 1);
        elements.previewCanvas.width = img.width * scale;
        elements.previewCanvas.height = img.height * scale;
        drawOverlay(ctx, img, title.trim(), detail.trim(), settings, elements.previewCanvas.width, elements.previewCanvas.height);
        elements.statusText.textContent = 'Preview updated.';
      } catch (e) {
        elements.statusText.textContent = `Preview failed: ${e.message}`;
      }
    }, DEBOUNCE_DELAY);

    const disableButtons = (disabled) => {
      elements.buttons.generateVideo.disabled = disabled || !imagesLoaded;
      elements.buttons.reset.disabled = disabled;
      elements.buttons.loadImages.disabled = disabled;
    };

    const loadImages = async () => {
      const csvLines = elements.csvInput.value.trim().split('\n').filter(l => l && validateCsvLine(l));
      if (!csvLines.length) {
        elements.statusText.textContent = 'Please add valid CSV input first.';
        return;
      }
      disableButtons(true);
      elements.statusText.textContent = 'Loading images...';
      elements.progressBar.style.width = '0%';
      imageCache.clear();
      imagesLoaded = false;

      for (let i = 0; i < csvLines.length; i++) {
        const [src] = csvLines[i].split(',');
        elements.statusText.textContent = `Loading image ${i + 1} of ${csvLines.length}...`;
        elements.progressBar.style.width = `${((i + 1) / csvLines.length) * 100}%`;
        try {
          await loadImage(src.trim());
        } catch (e) {
          elements.statusText.textContent = `Failed to load image: ${src}`;
          disableButtons(false);
          return;
        }
      }
      imagesLoaded = true;
      elements.buttons.generateVideo.disabled = false;
      elements.statusText.textContent = 'Images loaded successfully!';
      disableButtons(false);
      updatePreview();
    };

    const generateVideo = async () => {
      if (!imagesLoaded) {
        elements.statusText.textContent = 'Please load images first.';
        return;
      }
      const csvLines = elements.csvInput.value.trim().split('\n').filter(l => l && validateCsvLine(l));
      if (!csvLines.length) {
        elements.statusText.textContent = 'Please add valid CSV input first.';
        return;
      }
      disableButtons(true);
      elements.results.innerHTML = '';
      const settings = getSettings();

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = VIDEO_WIDTH;
      tempCanvas.height = VIDEO_HEIGHT;
      const tempCtx = tempCanvas.getContext('2d');

      const stream = tempCanvas.captureStream(FPS);
      const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8' });
      let chunks = [];
      recorder.ondataavailable = (e) => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const videoUrl = URL.createObjectURL(blob);
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
          <video controls src="${videoUrl}"></video><br>
          <a class="btn" href="${videoUrl}" download="output.webm">Download Video</a>
        `;
        elements.results.appendChild(div);
        elements.statusText.textContent = 'Video generated!';
        disableButtons(false);
      };

      recorder.start();

      let currentTime = 0;
      const totalDuration = csvLines.length * settings.duration;
      let currentIndex = 0;

      const progressInterval = setInterval(() => {
        currentTime += 0.1;
        elements.progressBar.style.width = `${(currentTime / totalDuration) * 100}%`;
      }, 100);

      const drawCurrent = () => {
        const [src, title, detail] = csvLines[currentIndex].split(',');
        const img = imageCache.get(src.trim());
        drawOverlay(tempCtx, img, title.trim(), detail.trim(), settings, VIDEO_WIDTH, VIDEO_HEIGHT);
        elements.statusText.textContent = `Processing image ${currentIndex + 1} of ${csvLines.length}...`;
      };

      const advance = () => {
        currentIndex++;
        if (currentIndex < csvLines.length) {
          drawCurrent();
          setTimeout(advance, settings.duration * 1000);
        } else {
          recorder.stop();
          clearInterval(progressInterval);
        }
      };

      drawCurrent();
      setTimeout(advance, settings.duration * 1000);
    };

    const resetSettings = () => {
      document.getElementById('titleSize').value = DEFAULT_SETTINGS.titleSize;
      document.getElementById('detailSize').value = DEFAULT_SETTINGS.detailSize;
      document.getElementById('textColor').value = DEFAULT_SETTINGS.textColor;
      document.getElementById('detailBg1').value = DEFAULT_SETTINGS.detailBg1;
      document.getElementById('detailBg2').value = DEFAULT_SETTINGS.detailBg2;
      document.getElementById('detailBgOpacity').value = DEFAULT_SETTINGS.detailBgOpacity;
      document.getElementById('titleBorderColor').value = DEFAULT_SETTINGS.titleBorderColor;
      document.getElementById('titleGlowColor').value = DEFAULT_SETTINGS.titleGlowColor;
      document.getElementById('titleSlider').value = DEFAULT_SETTINGS.titleSlider;
      document.getElementById('detailSlider').value = DEFAULT_SETTINGS.detailSlider;
      document.getElementById('titleAlign').value = DEFAULT_SETTINGS.titleAlign;
      document.getElementById('detailAlign').value = DEFAULT_SETTINGS.detailAlign;
      document.getElementById('fontFamily').value = DEFAULT_SETTINGS.fontFamily;
      document.getElementById('duration').value = DEFAULT_SETTINGS.duration;
      updateSliderValues();
      updatePreview();
      elements.statusText.textContent = 'Settings reset to default.';
      imagesLoaded = false;
      elements.buttons.generateVideo.disabled = true;
      imageCache.clear();
    };

    // Event Listeners
    elements.buttons.loadImages.addEventListener('click', loadImages);
    elements.buttons.generateVideo.addEventListener('click', generateVideo);
    elements.buttons.reset.addEventListener('click', resetSettings);

    elements.inputs.forEach(input => input.addEventListener('input', () => {
      updateSliderValues();
      updatePreview();
    }));

    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
      themeToggle.textContent = document.body.classList.contains('dark') ? 'Switch to Light' : 'Switch to Dark';
    });

    window.addEventListener('scroll', () => {
      goToTop.style.display = (window.scrollY > 100) ? 'block' : 'none';
    });

    goToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Initialize
    updateSliderValues();
    updatePreview();
    elements.buttons.generateVideo.disabled = true;
  </script>
</body>
</html>
