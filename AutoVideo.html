<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image-to-Video Animator with Export</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ccapture.js/1.1.0/CCapture.all.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            text-align: center; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        h1 { 
            background: #2c3e50; 
            color: white; 
            margin: 0; 
            padding: 20px; 
            text-align: center;
        }
        .controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        label { 
            font-weight: 600; 
            color: #555; 
            font-size: 14px;
        }
        textarea { 
            width: 100%; 
            height: 80px; 
            padding: 10px; 
            border: 2px solid #e9ecef; 
            border-radius: 6px; 
            resize: vertical;
            font-family: monospace;
            font-size: 12px;
        }
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        input[type="range"] { 
            width: 100%; 
            height: 6px; 
            border-radius: 3px; 
            background: #ddd; 
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        select {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
        }
        button { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary { 
            background: #007bff; 
            color: white; 
        }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { 
            background: #ffc107; 
            color: #212529; 
        }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { 
            background: #dc3545; 
            color: white; 
        }
        .btn-danger:hover { background: #c82333; }
        .btn-export { 
            padding: 12px 20px; 
            font-size: 16px; 
            margin: 5px;
        }
        #canvasContainer { 
            resize: both; 
            overflow: hidden; 
            width: 800px; 
            height: 450px; 
            margin: 20px auto; 
            border: 2px solid #dee2e6; 
            border-radius: 8px; 
            background: #fff;
            display: inline-block;
            position: relative;
        }
        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }
        .progress { 
            margin: 10px 0; 
            display: none; 
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s;
        }
        .download-link {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
        }
        .download-link:hover {
            background: #1e7e34;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px;
            border-radius: 6px;
            font-weight: 500;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @media (max-width: 768px) {
            .controls { grid-template-columns: 1fr; }
            #canvasContainer { width: 100%; height: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Image-to-Video Animator</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="urlInput">üì∑ Image URLs (CSV format):</label>
                <textarea id="urlInput" placeholder="https://via.placeholder.com/800x450/FF6B6B?text=Frame+1,https://via.placeholder.com/800x450/4ECDC4?text=Frame+2,https://via.placeholder.com/800x450/45B7D1?text=Frame+3,https://via.placeholder.com/800x450/96CEB4?text=Frame+4"></textarea>
                <button class="btn-primary" onclick="loadImages()">Load Images</button>
            </div>
            
            <div class="control-group">
                <label for="durationSlider">‚è±Ô∏è Frame Duration:</label>
                <input type="range" id="durationSlider" min="100" max="5000" step="100" value="2500">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                    <span>100ms (Fast)</span>
                    <span id="durationValue">2500 ms</span>
                    <span>5000ms (Slow)</span>
                </div>
            </div>
            
            <div class="control-group">
                <label for="aspectSelect">üìê Aspect Ratio:</label>
                <select id="aspectSelect">
                    <option value="custom">Custom Resize</option>
                    <option value="16:9">16:9 (YouTube Video)</option>
                    <option value="9:16">9:16 (YouTube Shorts)</option>
                    <option value="1:1">1:1 (Square)</option>
                    <option value="4:3">4:3 (Classic)</option>
                </select>
                <button class="btn-primary" onclick="applyAspect()">Apply Preset</button>
            </div>
        </div>

        <div style="padding: 0 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <button class="btn-success btn-export" onclick="startAnimation()">‚ñ∂Ô∏è Start Animation</button>
                    <button class="btn-danger btn-export" onclick="stopAnimation()">‚èπÔ∏è Stop Animation</button>
                </div>
                <div>
                    <button class="btn-warning btn-export" onclick="exportGIF()">üíæ Export GIF</button>
                    <button class="btn-success btn-export" onclick="exportMP4()">üé• Export MP4</button>
                </div>
            </div>
            
            <div id="progressContainer" class="progress">
                <div>Exporting... <span id="progressText"></span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div id="status" class="status" style="display: none;"></div>
            
            <div id="downloadLinks" style="margin: 20px 0; display: none;"></div>
        </div>

        <div id="canvasContainer">
            <canvas id="videoCanvas"></canvas>
        </div>
    </div>

    <script>
        const canvasContainer = document.getElementById('canvasContainer');
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d');
        const urlInput = document.getElementById('urlInput');
        const durationSlider = document.getElementById('durationSlider');
        const durationValue = document.getElementById('durationValue');
        const aspectSelect = document.getElementById('aspectSelect');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const status = document.getElementById('status');
        const downloadLinks = document.getElementById('downloadLinks');

        let images = [];
        let frame = 0;
        let animationId = null;
        let frameDuration = 2500;
        let gif = null;
        let capturer = null;
        let isExporting = false;

        // Update slider display
        durationSlider.addEventListener('input', () => {
            durationValue.textContent = `${durationSlider.value} ms`;
            frameDuration = parseInt(durationSlider.value);
        });

        // Show status message
        function showStatus(message, type = 'success') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', 3000);
        }

        // Load images from CSV
        function loadImages() {
            const urls = urlInput.value.split(',').map(u => u.trim()).filter(u => u);
            if (urls.length === 0) {
                showStatus('Please enter image URLs', 'error');
                return;
            }
            
            images = [];
            let loadedCount = 0;
            progressContainer.style.display = 'block';
            progressText.textContent = 'Loading images...';
            progressFill.style.width = '0%';

            urls.forEach((path, index) => {
                const img = new Image();
                img.crossOrigin = 'anonymous'; // For CORS
                img.src = path;
                img.onload = () => {
                    images.push(img);
                    loadedCount++;
                    const progress = (loadedCount / urls.length) * 100;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `Loaded ${loadedCount}/${urls.length} images`;
                    
                    if (loadedCount === urls.length) {
                        progressContainer.style.display = 'none';
                        showStatus(`Loaded ${images.length} images successfully!`);
                        frame = 0;
                    }
                };
                img.onerror = () => {
                    console.error(`Failed to load image: ${path}`);
                    loadedCount++;
                    if (loadedCount === urls.length) {
                        progressContainer.style.display = 'none';
                        showStatus(`Failed to load some images. Check console for details.`, 'error');
                    }
                };
            });
        }

        // Draw current frame with scaling
        function drawFrame() {
            if (images.length === 0) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const img = images[frame % images.length];
            const ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
            const w = img.width * ratio;
            const h = img.height * ratio;
            ctx.drawImage(img, (canvas.width - w) / 2, (canvas.height - h) / 2, w, h);
            frame++;
        }

        // Animation loop
        function animate() {
            if (isExporting) {
                // For export, we need to draw all frames sequentially
                drawFrame();
            } else {
                drawFrame();
                animationId = setTimeout(() => requestAnimationFrame(animate), frameDuration);
            }
        }

        function startAnimation() {
            if (animationId || images.length === 0) return;
            if (isExporting) return;
            animate();
            showStatus('Animation started');
        }

        function stopAnimation() {
            if (animationId) {
                clearTimeout(animationId);
                animationId = null;
            }
            if (isExporting) {
                isExporting = false;
                progressContainer.style.display = 'none';
            }
            showStatus('Animation stopped');
        }

        // Apply aspect ratio preset
        function applyAspect() {
            const value = aspectSelect.value;
            if (value === 'custom') return;
            const [wRatio, hRatio] = value.split(':').map(Number);
            const baseHeight = 450;
            const newWidth = (wRatio / hRatio) * baseHeight;
            const newHeight = baseHeight;
            canvasContainer.style.width = `${newWidth}px`;
            canvasContainer.style.height = `${newHeight}px`;
            canvas.width = newWidth;
            canvas.height = newHeight;
            drawFrame();
            showStatus(`Applied ${value} aspect ratio`);
        }

        // Resize observer for canvas
        const resizeObserver = new ResizeObserver((entries) => {
            for (const entry of entries) {
                canvas.width = entry.contentRect.width;
                canvas.height = entry.contentRect.height;
                if (images.length > 0) drawFrame();
            }
        });
        resizeObserver.observe(canvasContainer);

        // Initial setup
        canvas.width = canvasContainer.clientWidth;
        canvas.height = canvasContainer.clientHeight;

        // GIF Export
        function exportGIF() {
            if (images.length === 0) {
                showStatus('Please load images first', 'error');
                return;
            }
            
            isExporting = true;
            progressContainer.style.display = 'block';
            progressText.textContent = 'Creating GIF...';
            progressFill.style.width = '0%';
            
            // Clear previous downloads
            downloadLinks.innerHTML = '';
            downloadLinks.style.display = 'none';

            gif = new GIF({
                workers: 2,
                quality: 10,
                width: canvas.width,
                height: canvas.height,
                workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
            });

            gif.on('progress', (p) => {
                progressFill.style.width = `${p * 100}%`;
                progressText.textContent = `Creating GIF... ${Math.round(p * 100)}%`;
            });

            gif.on('finished', (blob) => {
                isExporting = false;
                progressContainer.style.display = 'none';
                
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const a = document.createElement('a');
                a.href = url;
                a.download = `animation_${timestamp}.gif`;
                a.className = 'download-link';
                a.textContent = 'üìÅ Download GIF';
                downloadLinks.appendChild(a);
                downloadLinks.style.display = 'block';
                
                showStatus('GIF export completed!');
            });

            // Add frames
            const totalFrames = images.length * 3; // 3 loops for smoother GIF
            let currentFrame = 0;
            
            function addNextFrame() {
                if (!isExporting) {
                    gif.abort();
                    return;
                }
                
                drawFrame();
                gif.addFrame(ctx, {delay: frameDuration, copy: true});
                currentFrame++;
                
                progressText.textContent = `Adding frames... ${currentFrame}/${totalFrames}`;
                
                if (currentFrame < totalFrames) {
                    setTimeout(addNextFrame, 50); // Add frames quickly
                } else {
                    gif.render();
                }
            }
            
            addNextFrame();
        }

        // MP4/WebM Export
        function exportMP4() {
            if (images.length === 0) {
                showStatus('Please load images first', 'error');
                return;
            }
            
            isExporting = true;
            progressContainer.style.display = 'block';
            progressText.textContent = 'Recording video...';
            progressFill.style.width = '0%';
            
            downloadLinks.innerHTML = '';
            downloadLinks.style.display = 'none';

            // Initialize CCapture
            capturer = new CCapture({
                format: 'webm',
                framerate: Math.round(1000 / frameDuration),
                quality: 100,
                verbose: false
            });

            capturer.start();
            
            const totalFrames = images.length * 2; // 2 loops
            let currentFrame = 0;
            
            function recordNextFrame() {
                if (!isExporting) {
                    capturer.stop();
                    capturer.save();
                    return;
                }
                
                drawFrame();
                capturer.capture(canvas);
                currentFrame++;
                
                progressText.textContent = `Recording... ${currentFrame}/${totalFrames}`;
                progressFill.style.width = `${(currentFrame / totalFrames) * 100}%`;
                
                if (currentFrame < totalFrames) {
                    setTimeout(recordNextFrame, frameDuration);
                } else {
                    capturer.stop();
                    capturer.save();
                    isExporting = false;
                    progressContainer.style.display = 'none';
                    showStatus('Video recording completed! Check browser downloads.');
                }
            }
            
            recordNextFrame();
        }

        // Sample data for testing
        window.addEventListener('load', () => {
            const sampleUrls = [
                
                'https://via.placeholder.com/800x450/96CEB4/FFFFFF?text=Frame+4',
                'https://via.placeholder.com/800x450/F7DC6F/000000?text=Frame+5'
            ].join(',');
            urlInput.value = sampleUrls;
        });
    </script>
</body>
</html>
